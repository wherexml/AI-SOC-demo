<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全工作流编排平台 - XDR AI 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#64748b',
                        accent: '#3b82f6',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        success: '#10b981'
                    }
                }
            }
        }
    </script>
    <style>
        .workflow-canvas {
            background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            user-select: none;
        }
        .workflow-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            cursor: grab;
        }
        .workflow-viewport:active {
            cursor: grabbing;
        }
        .workflow-container {
            position: absolute;
            width: 10000px;
            height: 10000px;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }
        .canvas-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .canvas-control-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .canvas-control-btn:hover {
            background: #f9fafb;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            overflow: hidden;
        }
        .minimap-content {
            width: 100%;
            height: 100%;
            position: relative;
            background: #f9fafb;
        }
        .minimap-viewport {
            position: absolute;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            cursor: pointer;
        }
        .minimap-node {
            position: absolute;
            background: #6b7280;
            border-radius: 2px;
            width: 8px;
            height: 6px;
        }
        .coordinates-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #6b7280;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .draggable-node {
            cursor: move;
            transition: all 0.2s ease;
            position: relative;
        }
        .draggable-node:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .draggable-node:hover .connection-hint {
            opacity: 1;
        }
        .connection-hint {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
            z-index: 1000;
        }
        .node-trigger { border-left: 4px solid #10b981; }
        .node-ai { border-left: 4px solid #3b82f6; }
        .node-agent { border-left: 4px solid #8b5cf6; }
        .node-soar { border-left: 4px solid #f59e0b; }
        .node-human { border-left: 4px solid #ef4444; }
        .node-logic { border-left: 4px solid #64748b; }
        .node-comment { border-left: 4px solid #f59e0b; background: #fefce8; }
        .node-group { border: 2px dashed #6366f1; background: rgba(99, 102, 241, 0.05); }
        
        .connector-endpoint {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            cursor: crosshair;
        }
        .endpoint-source {
            background: #10b981;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
        }
        .endpoint-target {
            background: #ef4444;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .sidebar-collapsed {
            width: 60px;
        }
        .sidebar-expanded {
            width: 280px;
        }
        
        .debug-highlight {
            animation: pulse 2s infinite;
            border: 2px solid #f59e0b !important;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 右键菜单样式 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
        }
        .context-menu-item:last-child {
            border-bottom: none;
        }
        .context-menu-item:hover {
            background: #f9fafb;
        }
        .context-menu-item.danger:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* 连接模式和端点增强样式 */
        body.connecting-mode {
            cursor: crosshair !important;
        }
        body.connecting-mode * {
            cursor: crosshair !important;
        }
        .endpoint-highlight {
            animation: pulse-endpoint 1.5s infinite;
        }
        @keyframes pulse-endpoint {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* 连接点默认隐藏 */
        .jtk-endpoint {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* 节点悬停或激活时显示连接点 */
        .workflow-node:hover .jtk-endpoint,
        .workflow-node.show-endpoints .jtk-endpoint {
            opacity: 1;
        }
        
        /* 连接指引 - 只在悬停时显示 */
        .workflow-node:hover::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -15px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
            animation: pulse-connection-hint 2s infinite;
        }
        .workflow-node:hover::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -15px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
            animation: pulse-connection-hint 2s infinite;
        }
        @keyframes pulse-connection-hint {
            0% { opacity: 0.6; transform: translateY(-50%) scale(1); }
            50% { opacity: 1; transform: translateY(-50%) scale(1.1); }
            100% { opacity: 0.6; transform: translateY(-50%) scale(1); }
        }
        
        /* 联络员Agent节点增强样式 */
        .agent-enhanced {
            border: 2px solid #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        
        .agent-enhanced:hover {
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        
        /* 输出锚点标记 */
        .output-anchor-marker {
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .agent-enhanced:hover .output-anchor-marker {
            opacity: 1;
            animation: pulse-anchor 2s infinite;
        }
        
        @keyframes pulse-anchor {
            0%, 100% { transform: translateX(50%) translateY(-50%) scale(1); opacity: 0.8; }
            50% { transform: translateX(50%) translateY(-50%) scale(1.2); opacity: 1; }
        }
        
        /* 端点标签样式 */
        .endpoint-label {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .agent-enhanced:hover .endpoint-label {
            opacity: 1;
        }
        
        /* 页签样式 */
        .tab-button {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .tab-button:hover {
            border-bottom-color: #93c5fd !important;
        }
        
        .tab-content {
            transition: opacity 0.3s ease;
        }
        
        /* 模板选择器强调样式 */
        #templateSelect {
            transition: all 0.3s ease;
        }
        
        #templateSelect:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* 指令配置表格样式 */
        .command-row {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .command-row:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        
        .command-row input {
            transition: border-color 0.2s ease;
        }
        
        .command-row input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        /* 连接标签样式 */
        .connection-label {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #c084fc;
            backdrop-filter: blur(4px);
        }
        
        /* 工作流节点优化 */
        .workflow-node {
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        /* 属性面板滚动样式 */
        #propertiesPanel .flex-1 {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f9fafb;
        }

        #propertiesPanel .flex-1::-webkit-scrollbar {
            width: 6px;
        }

        #propertiesPanel .flex-1::-webkit-scrollbar-track {
            background: #f9fafb;
            border-radius: 3px;
        }

        #propertiesPanel .flex-1::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        #propertiesPanel .flex-1::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* 确保面板高度正确 */
        #propertiesPanel {
            height: 100vh;
        }

        #propertiesPanel .flex-1 {
            min-height: 0;
            overflow-y: auto;
            max-height: calc(100vh - 80px); /* 减去头部高度 */
        }
        
        .workflow-node:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* 联络员Agent节点特殊标识 */
        .node-agent .font-semibold::after {
            content: " 🤖";
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <!-- 主页面：模板商店 -->
    <div id="templateStorePage" class="min-h-screen bg-gray-50">
        <!-- 顶部导航和统计 -->
        <div class="bg-white shadow-sm">
            <!-- 主导航 -->
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-project-diagram text-white text-lg"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">安全工作流编排平台</h1>
                                <p class="text-sm text-gray-500">XDR AI SecOps 2.0</p>
                            </div>
                        </div>
                        <div class="h-8 w-px bg-gray-300"></div>
                        <nav class="flex items-center space-x-6">
                            <button id="homeBtn" class="px-3 py-2 text-sm font-medium text-purple-600 bg-purple-50 rounded-lg">
                                <i class="fas fa-home mr-2"></i>工作流商店
                            </button>
                            <button id="editorBtn" class="px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-edit mr-2"></i>流程编辑器
                            </button>
                            <button id="monitorBtn" class="px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                                <i class="fas fa-chart-line mr-2"></i>运行监控
                            </button>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-500 flex items-center">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            系统运行正常
                        </div>
                        <button class="p-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100" title="帮助">
                            <i class="fas fa-question-circle"></i>
                        </button>
                        <button class="p-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100" title="设置">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 统计仪表板 -->
            <div class="px-6 py-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">今日执行</p>
                                <p class="text-2xl font-bold">1,247</p>
                                <p class="text-xs text-blue-200 mt-1">
                                    <i class="fas fa-arrow-up mr-1"></i>+12.5% 较昨日
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-play text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">成功率</p>
                                <p class="text-2xl font-bold">98.2%</p>
                                <p class="text-xs text-green-200 mt-1">
                                    <i class="fas fa-arrow-up mr-1"></i>+0.3% 较昨日
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">活跃工作流</p>
                                <p class="text-2xl font-bold">23</p>
                                <p class="text-xs text-orange-200 mt-1">
                                    <i class="fas fa-arrow-right mr-1"></i>运行中
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-stream text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">平均响应时间</p>
                                <p class="text-2xl font-bold">2.3s</p>
                                <p class="text-xs text-purple-200 mt-1">
                                    <i class="fas fa-arrow-down mr-1"></i>-0.5s 较昨日
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 模板商店内容区域 -->
        <div class="px-6 py-8">
            <div class="max-w-7xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Workflow模板商店</h2>
                    <p class="text-gray-600">选择预构建的安全运营工作流模板，快速开始您的自动化之旅</p>
                </div>
                
                <!-- 搜索和筛选 -->
                <div class="mb-8 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" placeholder="搜索模板..." 
                                   class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option>所有类别</option>
                            <option>告警事件威胁运营</option>
                            <option>资产漏洞风险管理</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <span>共 10 个模板</span>
                        <div class="w-px h-4 bg-gray-300"></div>
                        <button class="text-blue-600 hover:text-blue-700">最新</button>
                        <button class="text-gray-500 hover:text-gray-700">最热</button>
                        <button class="text-gray-500 hover:text-gray-700">推荐</button>
                    </div>
                </div>
                
                <!-- 模板卡片展示区域 -->
                <div class="space-y-12">
                    <!-- 告警事件威胁运营类 -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                            告警事件威胁运营类
                            <span class="ml-3 text-sm font-normal text-gray-500 bg-red-50 px-2 py-1 rounded-full">5个模板</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="demo-agent-contact">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-user-tie text-white text-xl"></i>
                                    </div>
                                    <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">演示</span>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">演示联络员Agent</h5>
                                <p class="text-gray-600 text-sm mb-4">智能安全运营专家，将JSON事件转换为专业企微通知消息</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 1-2分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>新功能
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="internet-attack-block">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-red-400 to-red-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-shield-alt text-white text-xl"></i>
                                    </div>
                                    <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">热门</span>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">互联网攻击自动化阻断流程</h5>
                                <p class="text-gray-600 text-sm mb-4">发生外到内真实攻击告警，实体分析后确认是否封堵</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 2-5分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>1,247次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="security-incident-response">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-orange-400 to-orange-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-fire text-white text-xl"></i>
                                    </div>
                                    <span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">推荐</span>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">重大安全事件应急响应流程</h5>
                                <p class="text-gray-600 text-sm mb-4">触发重要的安全事件后，自动化调查、分析、确认与响应流程</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 10-30分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>892次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="phishing-notification">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-fish text-white text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">钓鱼事件通知与闭环流程</h5>
                                <p class="text-gray-600 text-sm mb-4">用户点击钓鱼邮件，确认为真后，推送终端用户提醒并获得回复</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 5-15分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>634次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="executive-security-incident">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-crown text-white text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">高管安全事件专项流程</h5>
                                <p class="text-gray-600 text-sm mb-4">高管用户的安全事件，推送管理员确认后再自动化推送通知确认</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 15-45分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>423次使用
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 资产漏洞风险管理类 -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-server text-blue-500 mr-3"></i>
                            资产漏洞风险管理类
                            <span class="ml-3 text-sm font-normal text-gray-500 bg-blue-50 px-2 py-1 rounded-full">6个模板</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="core-asset-exposure">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-cyan-400 to-cyan-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-globe text-white text-xl"></i>
                                    </div>
                                    <span class="bg-cyan-100 text-cyan-800 text-xs px-2 py-1 rounded-full">新增</span>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">核心资产发现新的互联网暴露</h5>
                                <p class="text-gray-600 text-sm mb-4">对于设定的核心资产，发现了新的关键暴露面</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 3-10分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>156次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="agent-coverage-monitoring">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-green-400 to-green-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-chart-line text-white text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">Agent覆盖率监控与补齐流程</h5>
                                <p class="text-gray-600 text-sm mb-4">检测到新的新的安全事件但主机未安装Agent</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 5-20分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>287次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="high-risk-vulnerability">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-700 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-bug text-white text-xl"></i>
                                    </div>
                                    <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">高危</span>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">高可利用漏洞确认与修复流程</h5>
                                <p class="text-gray-600 text-sm mb-4">检测到高可利用漏洞，推送人工确认后进行流程化修复</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 30-120分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>512次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="vulnerability-lifecycle">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-indigo-400 to-indigo-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-recycle text-white text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">漏洞生命周期管理流程</h5>
                                <p class="text-gray-600 text-sm mb-4">完整的漏洞管理流程，包含责任人推送等</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 60-240分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>398次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="internet-exposure-closure">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-teal-400 to-teal-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-lock text-white text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">互联网暴露资产端口闭环流程</h5>
                                <p class="text-gray-600 text-sm mb-4">新增互联网暴露端口或服务</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 10-30分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>245次使用
                                    </div>
                                </div>
                            </div>

                            <div class="template-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-blue-500 hover:shadow-lg transition-all duration-300 group" 
                                 data-template="weak-password-response">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-amber-400 to-amber-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fas fa-key text-white text-xl"></i>
                                    </div>
                                </div>
                                <h5 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">弱口令风险自动响应流程</h5>
                                <p class="text-gray-600 text-sm mb-4">探测到重要弱口令并生成安全事件</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-xs text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        <span>预计执行时间: 5-15分钟</span>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        <i class="fas fa-download mr-1"></i>189次使用
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 底部提示 -->
                <div class="mt-12 text-center">
                    <div class="bg-blue-50 rounded-xl p-6 inline-block">
                        <i class="fas fa-lightbulb text-blue-500 text-2xl mb-2"></i>
                        <p class="text-blue-900 font-medium mb-1">点击任意模板开始编辑</p>
                        <p class="text-blue-700 text-sm">所有模板都已经过安全专家验证，可以直接使用或根据需要自定义</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作流编辑器页面（默认隐藏） -->
    <div id="workflowEditorPage" class="hidden">
        <!-- 顶部工具栏 -->
        <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button id="backToStoreBtn" class="p-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100" title="返回模板商店">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-project-diagram text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">工作流编辑器</h1>
                    </div>
                </div>
                <div class="h-6 w-px bg-gray-300"></div>
                <div class="flex items-center space-x-2">
                    <button id="saveBtn" class="px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                        <i class="fas fa-save mr-1"></i>保存
                    </button>
                    <button id="debugBtn" class="px-3 py-1.5 bg-orange-500 text-white rounded-md hover:bg-orange-600 text-sm">
                        <i class="fas fa-bug mr-1"></i>调试
                    </button>
                    <button id="publishBtn" class="px-3 py-1.5 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">
                        <i class="fas fa-rocket mr-1"></i>发布
                    </button>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-xs text-gray-500 bg-blue-50 px-3 py-1 rounded-md border border-blue-200">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    连线提示：悬停节点显示连接点，拖拽绿色点连接到红色点
                </div>
                <div class="text-sm text-gray-500">
                    <span class="w-2 h-2 bg-green-500 rounded-full inline-block mr-1"></span>
                    已保存
                </div>
                <button class="p-2 text-gray-500 hover:text-gray-700 rounded-md hover:bg-gray-100" 
                        title="帮助：绿色点为输出端，红色点为输入端">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
        </div>

    <div class="flex h-full">
        <!-- 左侧节点工具栏 -->
        <div id="sidebar" class="sidebar-expanded bg-white border-r border-gray-200 flex flex-col transition-all duration-300">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">节点库</h2>
                <button id="toggleSidebar" class="p-1 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <!-- 触发器节点 -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-bolt text-green-500 mr-2"></i>触发器节点
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-trigger bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="trigger" data-subtype="alert">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                            <span class="text-sm font-medium">告警触发器</span>
                        </div>
                        <div class="node-template draggable-node node-trigger bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="trigger" data-subtype="event">
                            <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                            <span class="text-sm font-medium">事件触发器</span>
                        </div>
                        <div class="node-template draggable-node node-trigger bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="trigger" data-subtype="webhook">
                            <i class="fas fa-plug text-purple-500 mr-2"></i>
                            <span class="text-sm font-medium">Webhook触发器</span>
                        </div>
                    </div>
                </div>

                <!-- AI Agent节点 -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-robot text-blue-500 mr-2"></i>AI Agent节点
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-ai bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="ai" data-subtype="investigate">
                            <i class="fas fa-search text-blue-500 mr-2"></i>
                            <span class="text-sm font-medium">调查溯源Agent</span>
                        </div>
                        <div class="node-template draggable-node node-ai bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="ai" data-subtype="disposal">
                            <i class="fas fa-shield-alt text-green-500 mr-2"></i>
                            <span class="text-sm font-medium">实体处置Agent</span>
                        </div>
                        <div class="node-template draggable-node node-ai bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="ai" data-subtype="custom">
                            <i class="fas fa-cog text-gray-500 mr-2"></i>
                            <span class="text-sm font-medium">自定义Agent</span>
                        </div>
                    </div>
                </div>

                <!-- 联络员Agent -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-user-tie text-purple-500 mr-2"></i>联络员Agent
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-agent bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="agent" data-subtype="contact">
                            <i class="fas fa-comments text-purple-500 mr-2"></i>
                            <span class="text-sm font-medium">联络员Agent</span>
                        </div>
                    </div>
                </div>

                <!-- SOAR引擎 -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-cogs text-orange-500 mr-2"></i>SOAR引擎
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-soar bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="soar" data-subtype="playbook">
                            <i class="fas fa-play-circle text-orange-500 mr-2"></i>
                            <span class="text-sm font-medium">处置Playbook</span>
                        </div>
                        <div class="node-template draggable-node node-soar bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="soar" data-subtype="ticket">
                            <i class="fas fa-ticket-alt text-orange-500 mr-2"></i>
                            <span class="text-sm font-medium">工单管理</span>
                        </div>
                    </div>
                </div>

                <!-- 人工节点 -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-user text-red-500 mr-2"></i>人工节点
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-human bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="human" data-subtype="confirm">
                            <i class="fas fa-check-circle text-red-500 mr-2"></i>
                            <span class="text-sm font-medium">人工确认</span>
                        </div>
                    </div>
                </div>

                <!-- 逻辑控制节点 -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-code-branch text-gray-500 mr-2"></i>逻辑控制
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-logic bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="logic" data-subtype="condition">
                            <i class="fas fa-question text-gray-500 mr-2"></i>
                            <span class="text-sm font-medium">条件判断</span>
                        </div>
                    </div>
                </div>

                <!-- 注释说明节点 -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-sticky-note text-yellow-500 mr-2"></i>注释说明
                    </h3>
                    <div class="space-y-2">
                        <div class="node-template draggable-node node-comment bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="comment" data-subtype="text">
                            <i class="fas fa-comment text-yellow-500 mr-2"></i>
                            <span class="text-sm font-medium">文字说明</span>
                        </div>
                        <div class="node-template draggable-node node-comment bg-gray-50 p-3 rounded-lg cursor-move" 
                             data-type="comment" data-subtype="group">
                            <i class="fas fa-object-group text-indigo-500 mr-2"></i>
                            <span class="text-sm font-medium">分组框</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要工作区域 -->
        <div class="flex-1 flex flex-col">
            <!-- 工作流画布 -->
            <div class="flex-1 relative">
                <div id="workflow-viewport" class="workflow-viewport">
                    <div id="workflow-canvas" class="workflow-canvas" style="width: 100%; height: 100%;">
                        <div id="workflow-container" class="workflow-container">
                    <!-- 示例工作流：重大安全事件智能响应流程 -->
                    <div id="start-node" class="workflow-node draggable-node node-trigger bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 100px; top: 100px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                            <span class="font-semibold text-sm">触发重大安全事件</span>
                        </div>
                        <div class="text-xs text-gray-500">告警触发器</div>
                    </div>

                    <div id="agent-node" class="workflow-node draggable-node node-agent bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 400px; top: 100px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-user-tie text-purple-500 mr-2"></i>
                            <span class="font-semibold text-sm">联络员Agent</span>
                        </div>
                        <div class="text-xs text-gray-500">企业微信负责人</div>
                    </div>

                    <div id="human-task" class="workflow-node draggable-node node-human bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 700px; top: 50px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-comments text-blue-500 mr-2"></i>
                            <span class="font-semibold text-sm">申请通知</span>
                        </div>
                        <div class="text-xs text-gray-500">企业微信回复超时</div>
                    </div>

                    <div id="investigate-agent" class="workflow-node draggable-node node-ai bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 700px; top: 200px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-search text-blue-500 mr-2"></i>
                            <span class="font-semibold text-sm">调查溯源Agent</span>
                        </div>
                        <div class="text-xs text-gray-500">资产/进程/网络</div>
                    </div>

                    <div id="disposal-agent" class="workflow-node draggable-node node-ai bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 1000px; top: 200px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-shield-alt text-green-500 mr-2"></i>
                            <span class="font-semibold text-sm">处置封堵Playbook</span>
                        </div>
                        <div class="text-xs text-gray-500">自动封堵</div>
                    </div>

                    <div id="ai-report" class="workflow-node draggable-node node-ai bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 1000px; top: 50px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                            <span class="font-semibold text-sm">AI总结闭环报告</span>
                        </div>
                        <div class="text-xs text-gray-500">企业微信+邮件</div>
                    </div>

                    <div id="soar-playbook" class="workflow-node draggable-node node-soar bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 1300px; top: 200px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-play-circle text-orange-500 mr-2"></i>
                            <span class="font-semibold text-sm">处置封堵Playbook</span>
                        </div>
                        <div class="text-xs text-gray-500">调用SOAR引擎</div>
                    </div>

                    <div id="ticket-node" class="workflow-node draggable-node node-soar bg-white rounded-lg shadow-md p-4 absolute" 
                         style="left: 1000px; top: 350px; width: 200px;">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-ticket-alt text-orange-500 mr-2"></i>
                            <span class="font-semibold text-sm">工单管理</span>
                        </div>
                        <div class="text-xs text-gray-500">创建处置工单</div>
                    </div>
                        </div>
                    </div>
                    
                    <!-- 画板控制按钮 -->
                    <div class="canvas-controls">
                        <button id="zoomIn" class="canvas-control-btn" title="放大">
                            <i class="fas fa-plus text-gray-600"></i>
                        </button>
                        <button id="zoomOut" class="canvas-control-btn" title="缩小">
                            <i class="fas fa-minus text-gray-600"></i>
                        </button>
                        <button id="zoomFit" class="canvas-control-btn" title="适应屏幕">
                            <i class="fas fa-expand-arrows-alt text-gray-600"></i>
                        </button>
                        <button id="resetView" class="canvas-control-btn" title="重置视图">
                            <i class="fas fa-home text-gray-600"></i>
                        </button>
                    </div>
                    
                    <!-- 小地图 -->
                    <div id="minimap" class="minimap">
                        <div class="minimap-content">
                            <div id="minimapViewport" class="minimap-viewport"></div>
                        </div>
                    </div>
                    
                    <!-- 坐标显示 -->
                    <div id="coordinatesDisplay" class="coordinates-display">
                        X: <span id="coordX">0</span>, Y: <span id="coordY">0</span>, 缩放: <span id="coordScale">100%</span>
                    </div>
                </div>
            </div>

            <!-- 底部状态栏 -->
            <div class="bg-white border-t border-gray-200 px-4 py-2 flex items-center justify-between text-sm">
                <div class="flex items-center space-x-4">
                    <span class="text-gray-500">节点数量: <span id="nodeCount">8</span></span>
                    <span class="text-gray-500">连接数量: <span id="connectionCount">8</span></span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-500">最后保存: 刚刚</span>
                    <button class="text-blue-500 hover:text-blue-700">查看执行日志</button>
                </div>
            </div>
        </div>

        <!-- 右侧属性配置面板 -->
        <div id="propertiesPanel" class="w-80 bg-white border-l border-gray-200 hidden flex flex-col h-full">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                <h3 class="font-semibold text-gray-900">节点属性</h3>
                <button id="closePropertiesPanel" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="nodeProperties">
                    <p class="text-gray-500 text-sm">请选择一个节点来配置属性</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" data-action="edit">
            <i class="fas fa-edit mr-2"></i>编辑节点
        </div>
        <div class="context-menu-item" data-action="copy">
            <i class="fas fa-copy mr-2"></i>复制节点
        </div>
        <div class="context-menu-item" data-action="disconnect">
            <i class="fas fa-unlink mr-2"></i>断开连接
        </div>
        <div class="context-menu-item danger" data-action="delete">
            <i class="fas fa-trash mr-2"></i>删除节点
        </div>
    </div>

    <!-- 调试模态框 -->
    <div id="debugModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">工作流调试模式</h3>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">模拟输入数据</label>
                        <textarea id="debugInput" class="w-full h-32 p-3 border border-gray-300 rounded-md" 
                                  placeholder='请输入JSON格式的测试数据，例如：
{
  "alert_id": "A12",
  "severity": "high",
  "asset_ip": "192.168.50.98",
  "attack_type": "file_upload",
  "source_ip": "1.1.112.102"
}'></textarea>
                    </div>
                    <div class="flex items-center justify-between">
                        <button id="startDebug" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                            <i class="fas fa-play mr-2"></i>开始调试
                        </button>
                        <button id="closeDebug" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 旧的模板商店模态框已移除，现在使用页面切换方式 -->

    <script>
        // 全局变量
        let jsPlumbInstance;
        let selectedNode = null;
        let nodeCounter = 0;
        let isDebugMode = false;
        let isDragging = false;
        let clickTimer = null;
        let isConnecting = false;
        
        // 无限画板相关变量
        let canvasState = {
            x: 0,
            y: 0,
            scale: 1,
            isPanning: false,
            lastPanPoint: { x: 0, y: 0 },
            minScale: 0.1,
            maxScale: 3,
            panSensitivity: 1
        };
        let workflowContainer = null;
        let workflowViewport = null;

        // 初始化jsPlumb
        function initJsPlumb() {
            jsPlumbInstance = jsPlumb.getInstance({
                Endpoint: ["Dot", { radius: 8 }],
                Connector: ["Bezier", { curviness: 80 }],
                HoverPaintStyle: { stroke: "#1e40af", strokeWidth: 3 },
                PaintStyle: { stroke: "#64748b", strokeWidth: 2, outlineStroke: "transparent", outlineWidth: 4 },
                ConnectionOverlays: [
                    ["Arrow", {
                        location: 1,
                        id: "arrow",
                        length: 14,
                        foldback: 0.8
                    }]
                ],
                Container: "workflow-container",
                DragOptions: { 
                    cursor: 'move', 
                    zIndex: 2000,
                    start: function(params) { 
                        isDragging = true;
                    },
                    stop: function(params) { 
                        setTimeout(() => { 
                            isDragging = false;
                        }, 100); 
                    }
                },
                PaintStyle: { stroke: '#64748b', strokeWidth: 2 },
                EndpointStyle: { fill: '#64748b', stroke: '#64748b' }
            });

            // 设置默认连接点样式
            jsPlumbInstance.registerEndpointType("source", {
                endpoint: "Dot",
                paintStyle: { 
                    fill: "#10b981", 
                    stroke: "#059669", 
                    strokeWidth: 2,
                    radius: 6 
                },
                isSource: true,
                connector: ["Bezier", { curviness: 80 }],
                connectorStyle: { stroke: "#64748b", strokeWidth: 2 },
                hoverPaintStyle: { 
                    fill: "#059669", 
                    stroke: "#047857", 
                    strokeWidth: 3,
                    radius: 8
                },
                connectorHoverStyle: { stroke: "#1e40af", strokeWidth: 3 },
                dragOptions: {},
                overlays: [
                    ["Arrow", { location: 1, width: 20, length: 20, id: "arrow" }]
                ]
            });

            jsPlumbInstance.registerEndpointType("target", {
                endpoint: "Dot",
                paintStyle: { 
                    fill: "#ef4444", 
                    stroke: "#dc2626", 
                    strokeWidth: 2,
                    radius: 6 
                },
                hoverPaintStyle: { 
                    fill: "#dc2626", 
                    stroke: "#b91c1c", 
                    strokeWidth: 3,
                    radius: 8
                },
                isTarget: true
            });

            // 使所有工作流节点可拖拽
            jsPlumbInstance.draggable(jsPlumbInstance.getSelector(".workflow-node"));

            // 为现有节点添加连接点
            setupExistingNodes();
            
            // 添加连接点增强功能
            setupEndpointEnhancements();

            // 连接事件监听
            jsPlumbInstance.bind("connection", function(info) {
                updateConnectionCount();
            });

            jsPlumbInstance.bind("connectionDetached", function(info) {
                updateConnectionCount();
            });

            // 连接开始和结束事件
            jsPlumbInstance.bind("beforeStartDetach", function(info) {
                isConnecting = true;
                return true;
            });

            jsPlumbInstance.bind("connectionDragStop", function(info) {
                setTimeout(() => { isConnecting = false; }, 100);
            });

            jsPlumbInstance.bind("beforeDrop", function(info) {
                isConnecting = false;
                return true;
            });
        }

        // 初始化无限画板
        function initInfiniteCanvas() {
            workflowViewport = document.getElementById('workflow-viewport');
            workflowContainer = document.getElementById('workflow-container');
            
            // 设置初始位置
            canvasState.x = 0;
            canvasState.y = 0;
            canvasState.scale = 1;
            updateCanvasTransform();
            
            // 添加事件监听
            setupCanvasEvents();
            setupCanvasControls();
            setupMinimap();
            updateCoordinates();
            
            // 延迟执行自适应，确保所有节点都已渲染
            setTimeout(() => {
                fitToScreen();
            }, 500);
        }
        
        // 设置画板事件
        function setupCanvasEvents() {
            const viewport = document.getElementById('workflow-viewport');
            const canvas = document.getElementById('workflow-canvas');
            const container = document.getElementById('workflow-container');
            
            // 检查是否点击在空白区域
            function isClickOnEmpty(target) {
                return target === viewport || target === canvas || target === container || 
                       target.classList.contains('workflow-canvas') || 
                       target.classList.contains('workflow-container') ||
                       target.classList.contains('workflow-viewport');
            }
            
            // 鼠标按下 - 开始拖拽
            viewport.addEventListener('mousedown', function(e) {
                // 只在空白区域才能拖拽画板，且不是节点，且不是控制按钮
                const isOnNode = e.target.closest('.workflow-node');
                const isOnControl = e.target.closest('.canvas-controls') || e.target.closest('.minimap') || e.target.closest('.coordinates-display');
                
                if (isClickOnEmpty(e.target) && !isOnNode && !isOnControl) {
                    if (e.button === 0) { // 左键
                        canvasState.isPanning = true;
                        canvasState.lastPanPoint = { x: e.clientX, y: e.clientY };
                        viewport.style.cursor = 'grabbing';
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }
            });
            
            // 鼠标移动 - 拖拽过程
            document.addEventListener('mousemove', function(e) {
                if (canvasState.isPanning) {
                    const deltaX = (e.clientX - canvasState.lastPanPoint.x) * canvasState.panSensitivity;
                    const deltaY = (e.clientY - canvasState.lastPanPoint.y) * canvasState.panSensitivity;
                    
                    canvasState.x += deltaX;
                    canvasState.y += deltaY;
                    
                    canvasState.lastPanPoint = { x: e.clientX, y: e.clientY };
                    
                    updateCanvasTransform();
                    updateCoordinates();
                    updateMinimap();
                    e.preventDefault();
                }
            });
            
            // 鼠标释放 - 结束拖拽
            document.addEventListener('mouseup', function(e) {
                if (canvasState.isPanning) {
                    canvasState.isPanning = false;
                    viewport.style.cursor = 'grab';
                }
            });
            
            // 鼠标离开窗口 - 结束拖拽
            document.addEventListener('mouseleave', function(e) {
                if (canvasState.isPanning) {
                    canvasState.isPanning = false;
                    viewport.style.cursor = 'grab';
                }
            });
            
            // 鼠标滚轮 - 缩放
            viewport.addEventListener('wheel', function(e) {
                e.preventDefault();
                
                const rect = viewport.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // Mac优化：更精细的缩放控制
                const scaleFactor = 0.03; // 降低敏感度
                const direction = e.deltaY > 0 ? -1 : 1;
                const delta = 1 + (direction * scaleFactor);
                
                const newScale = Math.max(canvasState.minScale, Math.min(canvasState.maxScale, canvasState.scale * delta));
                
                if (newScale !== canvasState.scale) {
                    // 以鼠标位置为中心缩放
                    const scaleRatio = newScale / canvasState.scale;
                    canvasState.x = mouseX - (mouseX - canvasState.x) * scaleRatio;
                    canvasState.y = mouseY - (mouseY - canvasState.y) * scaleRatio;
                    canvasState.scale = newScale;
                    
                    updateCanvasTransform();
                    updateCoordinates();
                    updateMinimap();
                }
            });
        }
        
        // 设置控制按钮
        function setupCanvasControls() {
            document.getElementById('zoomIn').addEventListener('click', function() {
                zoomCanvas(1.2);
            });
            
            document.getElementById('zoomOut').addEventListener('click', function() {
                zoomCanvas(0.8);
            });
            
            document.getElementById('zoomFit').addEventListener('click', function() {
                fitToScreen();
            });
            
            document.getElementById('resetView').addEventListener('click', function() {
                resetView();
            });
        }
        
        // 缩放画板
        function zoomCanvas(factor) {
            const newScale = Math.max(canvasState.minScale, Math.min(canvasState.maxScale, canvasState.scale * factor));
            
            if (newScale !== canvasState.scale) {
                const viewport = workflowViewport.getBoundingClientRect();
                const centerX = viewport.width / 2;
                const centerY = viewport.height / 2;
                
                const scaleRatio = newScale / canvasState.scale;
                canvasState.x = centerX - (centerX - canvasState.x) * scaleRatio;
                canvasState.y = centerY - (centerY - canvasState.y) * scaleRatio;
                canvasState.scale = newScale;
                
                updateCanvasTransform();
                updateCoordinates();
                updateMinimap();
            }
        }
        
        // 适应屏幕
        function fitToScreen() {
            const nodes = document.querySelectorAll('.workflow-node');
            if (nodes.length === 0) {
                // 没有节点时，居中显示
                canvasState.x = 0;
                canvasState.y = 0;
                canvasState.scale = 1;
                updateCanvasTransform();
                updateCoordinates();
                updateMinimap();
                return;
            }
            
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            
            nodes.forEach(node => {
                const x = parseInt(node.style.left) || 0;
                const y = parseInt(node.style.top) || 0;
                const width = parseInt(node.style.width) || 200;
                const height = node.offsetHeight || 80;
                
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x + width);
                maxY = Math.max(maxY, y + height);
            });
            
            const padding = 100; // 边距
            const contentWidth = maxX - minX + padding * 2;
            const contentHeight = maxY - minY + padding * 2;
            
            const viewport = workflowViewport.getBoundingClientRect();
            const scaleX = viewport.width / contentWidth;
            const scaleY = viewport.height / contentHeight;
            const scale = Math.min(scaleX, scaleY, 1); // 不超过100%
            
            canvasState.scale = Math.max(canvasState.minScale, Math.min(canvasState.maxScale, scale));
            
            // 计算居中位置
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            canvasState.x = viewport.width / 2 - centerX * canvasState.scale;
            canvasState.y = viewport.height / 2 - centerY * canvasState.scale;
            
            updateCanvasTransform();
            updateCoordinates();
            updateMinimap();
        }
        
        // 重置视图
        function resetView() {
            // 重置到适应所有节点的视图
            fitToScreen();
        }
        
        // 更新画板变换
        function updateCanvasTransform() {
            const transform = `translate(${canvasState.x}px, ${canvasState.y}px) scale(${canvasState.scale})`;
            workflowContainer.style.transform = transform;
        }
        
        // 更新坐标显示
        function updateCoordinates() {
            document.getElementById('coordX').textContent = Math.round(-canvasState.x / canvasState.scale);
            document.getElementById('coordY').textContent = Math.round(-canvasState.y / canvasState.scale);
            document.getElementById('coordScale').textContent = Math.round(canvasState.scale * 100) + '%';
        }
        
        // 设置小地图
        function setupMinimap() {
            const minimapViewport = document.getElementById('minimapViewport');
            
            // 点击小地图移动视图
            minimapViewport.parentElement.addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                const minimapScale = 0.02; // 小地图缩放比例
                const targetX = -(clickX / minimapScale - workflowViewport.clientWidth / 2);
                const targetY = -(clickY / minimapScale - workflowViewport.clientHeight / 2);
                
                canvasState.x = targetX;
                canvasState.y = targetY;
                
                updateCanvasTransform();
                updateCoordinates();
                updateMinimap();
            });
            
            updateMinimap();
        }
        
        // 更新小地图
        function updateMinimap() {
            const minimapViewport = document.getElementById('minimapViewport');
            const minimapScale = 0.02;
            
            // 更新视图框位置
            const viewportWidth = workflowViewport.clientWidth * minimapScale;
            const viewportHeight = workflowViewport.clientHeight * minimapScale;
            const viewportX = -canvasState.x * minimapScale;
            const viewportY = -canvasState.y * minimapScale;
            
            minimapViewport.style.width = viewportWidth + 'px';
            minimapViewport.style.height = viewportHeight + 'px';
            minimapViewport.style.left = viewportX + 'px';
            minimapViewport.style.top = viewportY + 'px';
            
            // 更新小地图中的节点位置
            updateMinimapNodes();
        }
        
        // 更新小地图节点
        function updateMinimapNodes() {
            const minimapContent = document.querySelector('.minimap-content');
            const existingMinimapNodes = minimapContent.querySelectorAll('.minimap-node');
            existingMinimapNodes.forEach(node => node.remove());
            
            const workflowNodes = document.querySelectorAll('.workflow-node');
            const minimapScale = 0.02;
            
            workflowNodes.forEach(node => {
                const minimapNode = document.createElement('div');
                minimapNode.className = 'minimap-node';
                
                const x = (parseInt(node.style.left) || 0) * minimapScale;
                const y = (parseInt(node.style.top) || 0) * minimapScale;
                
                minimapNode.style.left = x + 'px';
                minimapNode.style.top = y + 'px';
                
                minimapContent.appendChild(minimapNode);
            });
        }
        
        // 设置现有节点的连接点
        function setupExistingNodes() {
            // 为现有节点添加连接点
            const existingNodes = document.querySelectorAll('.workflow-node');
            existingNodes.forEach(node => {
                addNodeEndpoints(node);
                
                // 特别为联络员节点添加增强功能
                if (node.classList.contains('node-agent')) {
                    // 延迟添加视觉增强，确保节点已完全渲染
                    setTimeout(() => {
                        addAgentVisualEnhancements(node);
                    }, 200);
                }
            });

            // 添加连接
            jsPlumbInstance.connect({
                source: "start-node",
                target: "agent-node",
                anchors: ["Right", "Left"]
            });

            jsPlumbInstance.connect({
                source: "agent-node",
                target: "human-task",
                anchors: ["Right", "Left"],
                overlays: [["Label", { label: "超时未回复", location: 0.5, cssClass: "text-xs bg-yellow-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "agent-node",
                target: "investigate-agent",
                anchors: ["Right", "Left"],
                overlays: [["Label", { label: "获得处置回复", location: 0.5, cssClass: "text-xs bg-green-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "investigate-agent",
                target: "disposal-agent",
                anchors: ["Right", "Left"],
                overlays: [["Label", { label: "输入封堵实体", location: 0.5, cssClass: "text-xs bg-blue-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "disposal-agent",
                target: "soar-playbook",
                anchors: ["Right", "Left"],
                overlays: [["Label", { label: "调用SOAR", location: 0.5, cssClass: "text-xs bg-orange-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "human-task",
                target: "ai-report",
                anchors: ["Right", "Left"],
                overlays: [["Label", { label: "无需处置", location: 0.5, cssClass: "text-xs bg-gray-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "disposal-agent",
                target: "ticket-node",
                anchors: ["Bottom", "Top"],
                overlays: [["Label", { label: "创建工单", location: 0.5, cssClass: "text-xs bg-orange-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "soar-playbook",
                target: "ai-report",
                anchors: ["Top", "Bottom"],
                overlays: [["Label", { label: "返回结果", location: 0.5, cssClass: "text-xs bg-purple-100 px-2 py-1 rounded" }]]
            });

            jsPlumbInstance.connect({
                source: "ticket-node",
                target: "ai-report",
                anchors: ["Right", "Bottom"],
                overlays: [["Label", { label: "工单完成", location: 0.5, cssClass: "text-xs bg-green-100 px-2 py-1 rounded" }]]
            });
        }

        // 设置连接点增强功能
        function setupEndpointEnhancements() {
            // 为每个节点存储独立的定时器
            const nodeTimers = new Map();
            
            // 为所有节点添加悬停事件，显示连接点
            document.addEventListener('mouseover', function(e) {
                const node = e.target.closest('.workflow-node');
                if (node && !node.classList.contains('node-comment') && !node.classList.contains('node-group')) {
                    // 清除该节点的隐藏定时器
                    if (nodeTimers.has(node)) {
                        clearTimeout(nodeTimers.get(node));
                        nodeTimers.delete(node);
                    }
                    
                    // 显示连接点
                    node.classList.add('show-endpoints');
                    
                    const endpoints = jsPlumbInstance.getEndpoints(node);
                    if (endpoints) {
                        endpoints.forEach(endpoint => {
                            endpoint.addClass('endpoint-highlight');
                        });
                    }
                }
            });
            
            // 鼠标离开时延迟隐藏连接点
            document.addEventListener('mouseout', function(e) {
                const node = e.target.closest('.workflow-node');
                if (node && !node.classList.contains('node-comment') && !node.classList.contains('node-group')) {
                    // 为该节点设置延迟隐藏定时器
                    const timer = setTimeout(() => {
                        node.classList.remove('show-endpoints');
                        
                        const endpoints = jsPlumbInstance.getEndpoints(node);
                        if (endpoints) {
                            endpoints.forEach(endpoint => {
                                endpoint.removeClass('endpoint-highlight');
                            });
                        }
                        
                        // 清理定时器引用
                        nodeTimers.delete(node);
                    }, 1000); // 1秒延迟
                    
                    nodeTimers.set(node, timer);
                }
            });
            
            // 连接开始时的视觉反馈
            jsPlumbInstance.bind("connectionDrag", function(connection) {
                document.body.classList.add('connecting-mode');
                // 连接时显示所有节点的连接点
                document.querySelectorAll('.workflow-node').forEach(node => {
                    if (!node.classList.contains('node-comment') && !node.classList.contains('node-group')) {
                        node.classList.add('show-endpoints');
                    }
                });
            });
            
            // 连接结束时移除视觉反馈
            jsPlumbInstance.bind("connectionDragStop", function(connection) {
                document.body.classList.remove('connecting-mode');
                // 延迟隐藏所有连接点
                setTimeout(() => {
                    document.querySelectorAll('.workflow-node').forEach(node => {
                        node.classList.remove('show-endpoints');
                    });
                }, 1500);
            });
        }

        // 为节点添加连接点
        function addNodeEndpoints(node) {
            // 检查是否已经有连接点
            const existingEndpoints = jsPlumbInstance.getEndpoints(node);
            if (existingEndpoints && existingEndpoints.length > 0) {
                return; // 已经有连接点，直接返回
            }

            // 移除现有的连接点HTML元素
            const existingHTMLEndpoints = node.querySelectorAll('.connector-endpoint');
            existingHTMLEndpoints.forEach(ep => ep.remove());

            try {
                // 检查是否是联络员Agent节点
                if (node.classList.contains('node-agent')) {
                    addAgentEndpoints(node);
                } else {
                    // 其他节点的标准连接点
                    addStandardEndpoints(node);
                }
            } catch (e) {
                console.warn('添加连接点失败:', e);
            }
        }
        
        // 为标准节点添加连接点
        function addStandardEndpoints(node) {
                // 添加源连接点（右侧）
                jsPlumbInstance.addEndpoint(node, {
                    anchor: "Right",
                    type: "source",
                    uuid: node.id + "-source",
                    maxConnections: -1
                });

                // 添加目标连接点（左侧）
                jsPlumbInstance.addEndpoint(node, {
                    anchor: "Left",
                    type: "target",
                    uuid: node.id + "-target",
                    maxConnections: -1
                });

                // 添加顶部和底部连接点用于复杂连线
                jsPlumbInstance.addEndpoint(node, {
                    anchor: "Top",
                    type: "source",
                    uuid: node.id + "-top-source",
                    maxConnections: -1
                });

                jsPlumbInstance.addEndpoint(node, {
                    anchor: "Bottom",
                    type: "target",
                    uuid: node.id + "-bottom-target",
                    maxConnections: -1
                });
        }
        
        // 为联络员Agent节点添加多个输出锚点
        function addAgentEndpoints(node) {
            // 添加输入连接点（左侧）
            jsPlumbInstance.addEndpoint(node, {
                anchor: "Left",
                type: "target",
                uuid: node.id + "-target",
                maxConnections: -1
            });
            
            // 添加多个输出锚点（右侧和底部）
            const outputAnchors = [
                { anchor: [1, 0.2], label: "get_details", description: "查看详情" },
                { anchor: [1, 0.4], label: "containment_approved", description: "一键遏制" },
                { anchor: [1, 0.6], label: "marked_as_done", description: "标记完成" },
                { anchor: [1, 0.8], label: "re_investigate", description: "调查" }
            ];
            
            outputAnchors.forEach((config, index) => {
                const endpoint = jsPlumbInstance.addEndpoint(node, {
                    anchor: config.anchor,
                    type: "source",
                    uuid: node.id + "-" + config.label,
                    maxConnections: -1,
                    overlays: [
                        ["Label", {
                            label: config.description,
                            location: [1.5, 0.5],
                            cssClass: "endpoint-label text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded shadow-sm",
                            id: "label-" + config.label
                        }]
                    ]
                });
            });
            
            // 为联络员节点添加视觉提示
            addAgentVisualEnhancements(node);
        }
        
        // 为联络员节点添加视觉增强
        function addAgentVisualEnhancements(node) {
            // 添加输出锚点的视觉标记
            const existingMarkers = node.querySelectorAll('.output-anchor-marker');
            existingMarkers.forEach(marker => marker.remove());
            
            const anchorPositions = [
                { top: '20%', label: '详情' },
                { top: '40%', label: '遏制' },
                { top: '60%', label: '完成' },
                { top: '80%', label: '调查' }
            ];
            
            anchorPositions.forEach(pos => {
                const marker = document.createElement('div');
                marker.className = 'output-anchor-marker absolute right-0 transform translate-x-1/2 w-3 h-3 bg-purple-500 rounded-full border-2 border-white shadow-sm';
                marker.style.top = pos.top;
                marker.style.transform = 'translateX(50%) translateY(-50%)';
                marker.title = pos.label + '分支输出';
                node.appendChild(marker);
            });
            
            // 添加节点特殊样式
            node.classList.add('agent-enhanced');
        }

        // 第一个事件监听器已合并到页面初始化部分

        // 设置拖拽功能
        function setupDragAndDrop() {
            const canvas = document.getElementById('workflow-canvas');
            const nodeTemplates = document.querySelectorAll('.node-template');

            nodeTemplates.forEach(template => {
                template.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        type: this.dataset.type,
                        subtype: this.dataset.subtype,
                        html: this.outerHTML
                    }));
                });

                template.setAttribute('draggable', 'true');
            });

            canvas.addEventListener('dragover', function(e) {
                e.preventDefault();
            });

            canvas.addEventListener('drop', function(e) {
                e.preventDefault();
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                
                // 获取鼠标相对于画板的位置
                const viewportRect = workflowViewport.getBoundingClientRect();
                const mouseX = e.clientX - viewportRect.left;
                const mouseY = e.clientY - viewportRect.top;
                
                // 转换到画板坐标系
                const x = (mouseX - canvasState.x) / canvasState.scale;
                const y = (mouseY - canvasState.y) / canvasState.scale;
                
                // 确保新节点在合理位置（非负坐标）
                const finalX = Math.max(50, x);
                const finalY = Math.max(50, y);
                
                createNode(data, finalX, finalY);
            });
        }

        // 创建新节点
        function createNode(data, x, y) {
            nodeCounter++;
            const nodeId = `node-${nodeCounter}`;
            
            const nodeElement = document.createElement('div');
            nodeElement.id = nodeId;
            nodeElement.className = `workflow-node draggable-node node-${data.type} bg-white rounded-lg shadow-md p-4 absolute`;
            nodeElement.style.left = x + 'px';
            nodeElement.style.top = y + 'px';
            
            // 根据节点类型设置尺寸
            if (data.type === 'comment') {
                if (data.subtype === 'group') {
                    nodeElement.style.width = '300px';
                    nodeElement.style.height = '200px';
                    nodeElement.className = `workflow-node draggable-node node-group bg-white rounded-lg shadow-md p-4 absolute`;
                } else {
                    nodeElement.style.width = '250px';
                    nodeElement.style.minHeight = '80px';
                }
            } else {
                nodeElement.style.width = '200px';
            }
            
            // 根据节点类型设置内容
            const nodeContent = getNodeContent(data);
            nodeElement.innerHTML = nodeContent;
            
            document.getElementById('workflow-canvas').appendChild(nodeElement);
            
            // 使新节点可拖拽
            jsPlumbInstance.draggable(nodeElement);
            
            // 为非注释节点添加连接点
            if (data.type !== 'comment') {
                // 延迟添加连接点，确保DOM已完全渲染
                setTimeout(() => {
                    addNodeEndpoints(nodeElement);
                }, 100);
            }
            
            // 更新节点计数
            updateNodeCount();
            
            // 更新小地图
            updateMinimapNodes();
        }

        // 获取节点内容
        function getNodeContent(data) {
            const icons = {
                trigger: {
                    alert: 'fas fa-exclamation-triangle text-red-500',
                    event: 'fas fa-calendar-alt text-blue-500',
                    webhook: 'fas fa-plug text-purple-500'
                },
                ai: {
                    investigate: 'fas fa-search text-blue-500',
                    disposal: 'fas fa-shield-alt text-green-500',
                    custom: 'fas fa-cog text-gray-500'
                },
                agent: {
                    contact: 'fas fa-comments text-purple-500'
                },
                soar: {
                    playbook: 'fas fa-play-circle text-orange-500',
                    ticket: 'fas fa-ticket-alt text-orange-500'
                },
                human: {
                    confirm: 'fas fa-check-circle text-red-500'
                },
                logic: {
                    condition: 'fas fa-question text-gray-500'
                },
                comment: {
                    text: 'fas fa-comment text-yellow-500',
                    group: 'fas fa-object-group text-indigo-500'
                }
            };

            const names = {
                trigger: {
                    alert: '告警触发器',
                    event: '事件触发器',
                    webhook: 'Webhook触发器'
                },
                ai: {
                    investigate: '调查溯源Agent',
                    disposal: '实体处置Agent',
                    custom: '自定义Agent'
                },
                agent: {
                    contact: '联络员Agent'
                },
                soar: {
                    playbook: '处置Playbook',
                    ticket: '工单管理'
                },
                human: {
                    confirm: '人工确认'
                },
                logic: {
                    condition: '条件判断'
                },
                comment: {
                    text: '文字说明',
                    group: '分组框'
                }
            };

            const iconClass = icons[data.type][data.subtype];
            const nodeName = names[data.type][data.subtype];

            // 注释节点特殊处理
            if (data.type === 'comment') {
                if (data.subtype === 'group') {
                    return `
                        <div class="flex items-center mb-2">
                            <i class="${iconClass} mr-2"></i>
                            <span class="font-semibold text-sm">${nodeName}</span>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">双击编辑分组说明</div>
                        <div class="text-center text-gray-400 border-2 border-dashed border-gray-300 rounded p-4 mt-4">
                            <p class="text-sm">拖拽节点到此区域进行分组</p>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex items-center mb-2">
                            <i class="${iconClass} mr-2"></i>
                            <span class="font-semibold text-sm">${nodeName}</span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">双击编辑内容</div>
                        <div class="text-sm text-gray-700 editable-text p-2 border border-gray-200 rounded" 
                             contenteditable="true" placeholder="在此输入说明文字...">
                            点击输入说明文字...
                        </div>
                    `;
                }
            }

            return `
                <div class="connection-hint">拖拽圆点连接到其他节点</div>
                <div class="flex items-center mb-2">
                    <i class="${iconClass} mr-2"></i>
                    <span class="font-semibold text-sm">${nodeName}</span>
                </div>
                <div class="text-xs text-gray-500">点击配置</div>
            `;
        }

        // 选择节点
        function selectNode(node) {
            // 如果正在拖拽或连线，不执行选择
            if (isDragging || isConnecting || canvasState.isPanning) {
                return;
            }
            
            // 移除之前选中的节点高亮
            clearSelection();
            
            // 高亮当前选中的节点
            node.classList.add('ring-2', 'ring-blue-500');
            selectedNode = node;
            
            // 显示属性面板
            showNodeProperties(node);
        }
        
        // 清除选择
        function clearSelection() {
            document.querySelectorAll('.workflow-node').forEach(n => {
                n.classList.remove('ring-2', 'ring-blue-500');
            });
            selectedNode = null;
            document.getElementById('propertiesPanel').classList.add('hidden');
        }

        // 显示节点属性
        function showNodeProperties(node) {
            const panel = document.getElementById('propertiesPanel');
            const properties = document.getElementById('nodeProperties');
            
            panel.classList.remove('hidden');
            
            // 根据节点类型显示不同的属性配置
            const nodeType = getNodeType(node);
            properties.innerHTML = getNodePropertiesHTML(nodeType, node);
            
            // 添加通用的点击事件处理，防止面板内的点击事件冒泡
            setupPropertiesPanelEvents(panel);
            
            // 如果是联络员节点，需要初始化专门的功能
            if (nodeType === 'agent') {
                initAgentConfiguration();
            }
        }
        
        // 设置属性面板事件处理
        function setupPropertiesPanelEvents(panel) {
            // 为面板添加点击事件处理，阻止事件冒泡
            panel.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // 为面板内的所有输入元素添加事件处理
            const inputs = panel.querySelectorAll('input, textarea, select, button');
            inputs.forEach(input => {
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                input.addEventListener('change', function(e) {
                    e.stopPropagation();
                });
                
                input.addEventListener('focus', function(e) {
                    e.stopPropagation();
                });
            });
        }
        
        // 初始化联络员Agent的配置功能
        function initAgentConfiguration() {
            // 页签切换功能
            const messageTemplateTab = document.getElementById('messageTemplateTab');
            const interactionTab = document.getElementById('interactionTab');
            const messageTemplateContent = document.getElementById('messageTemplateContent');
            const interactionContent = document.getElementById('interactionContent');
            
            if (messageTemplateTab) {
                messageTemplateTab.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    // 切换页签样式
                    messageTemplateTab.className = 'tab-button border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium';
                    interactionTab.className = 'tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium';
                    
                    // 切换内容显示
                    messageTemplateContent.classList.remove('hidden');
                    interactionContent.classList.add('hidden');
                });
            }
            
            if (interactionTab) {
                interactionTab.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    // 切换页签样式
                    interactionTab.className = 'tab-button border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium';
                    messageTemplateTab.className = 'tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium';
                    
                    // 切换内容显示
                    interactionContent.classList.remove('hidden');
                    messageTemplateContent.classList.add('hidden');
                });
            }
            
            // 模板库功能
            const templateSelect = document.getElementById('templateSelect');
            const messageTemplate = document.getElementById('messageTemplate');
            
            if (templateSelect) {
                templateSelect.addEventListener('change', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    const selectedTemplate = this.value;
                    if (selectedTemplate && messageTemplate) {
                        const promptContent = getPromptTemplate(selectedTemplate);
                        messageTemplate.value = promptContent;
                    }
                });
                
                // 为下拉菜单添加点击事件阻止冒泡
                templateSelect.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // 接收人类型选择功能
            const recipientType = document.getElementById('recipientType');
            const recipientInput = document.getElementById('recipientInput');
            
            if (recipientType && recipientInput) {
                recipientType.addEventListener('change', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    
                    const selectedType = this.value;
                    
                    if (selectedType === 'asset_owner') {
                        recipientInput.disabled = true;
                        recipientInput.value = '';
                        recipientInput.placeholder = '系统自动识别事件关联资产的责任人';
                        recipientInput.classList.add('disabled:bg-gray-100', 'disabled:text-gray-500');
                    } else if (selectedType === 'admin') {
                        recipientInput.disabled = true;
                        recipientInput.value = '';
                        recipientInput.placeholder = '系统自动推送给管理员用户组';
                        recipientInput.classList.add('disabled:bg-gray-100', 'disabled:text-gray-500');
                    } else if (selectedType === 'custom') {
                        recipientInput.disabled = false;
                        recipientInput.value = '';
                        recipientInput.placeholder = '@用户名或角色组';
                        recipientInput.classList.remove('disabled:bg-gray-100', 'disabled:text-gray-500');
                        recipientInput.focus();
                    }
                });
                
                // 为下拉菜单添加点击事件阻止冒泡
                recipientType.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // 初始化状态
                recipientType.dispatchEvent(new Event('change'));
            }
        }
        
        // 获取Prompt模板内容
        function getPromptTemplate(templateType) {
            const templates = {
                'security_incident': `# 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的安全事件报告，转换为一份清晰、准确、专业的企微通知消息，以便一线分析师能快速理解情况并做出决策。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在（如漏洞信息），请在生成的内容中智能地说明情况（如"暂无关联漏洞信息"），以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、冷静、紧急，但不能引发不必要的恐慌。

# 事件JSON数据
[此处将动态插入上述示例JSON]

# 输出格式与内容要求
【安全事件通知】您好！我是您的安全助手 Bot。系统于 [清晰地写出事件发生的具体时间] 监测到一条 [明确指出事件的严重等级]安全事件，请在 [写出规则中设定的响应超时分钟数] 分钟 内确认并选择处置方式（测试阶段，如有打扰敬请諒解，或需人工协助请 @信息安全部-服务号）。
⸻
• GPT研判结论：[概括并填入AI的核心研判结论]
• 威胁等级：[再次明确威胁等级]
• 受影响资产：[描述受影响资产的关键信息，包括其IP、端口和业务描述]
• 攻击源 IP：[描述攻击源的IP地址及其地理位置]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
一键遏制
标记完成
调查
若超时未回复，事件将进入「待人工复核」队列并持续监控。感谢配合！`,
                
                'asset_exposure': `# 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的资产暴露事件报告，转换为一份清晰、准确、专业的企微通知消息，以便资产负责人能快速理解风险并做出决策。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在，请在生成的内容中智能地说明情况，以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、冷静、提醒性，强调风险但避免过度恐慌。

# 事件JSON数据
[此处将动态插入资产暴露事件JSON]

# 输出格式与内容要求
【资产暴露通知】您好！我是您的安全助手 Bot。系统于 [清晰地写出发现时间] 发现您负责的资产存在新的互联网暴露，请在 [写出规则中设定的响应超时分钟数] 分钟内确认处置方式。
⸻
• GPT研判结论：[概括并填入AI的核心风险评估结论]
• 风险等级：[明确指出风险等级]
• 暴露资产：[描述暴露资产的关键信息，包括其IP、端口和业务描述]
• 服务类型：[描述暴露的服务类型和协议]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
确认处置
标记已知
风险评估
若超时未回复，将自动升级处理。感谢配合！`,
                
                'vulnerability': `# 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的漏洞检测报告，转换为一份清晰、准确、专业的企微通知消息，以便资产负责人能快速理解漏洞风险并做出处置决策。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在（如CVE编号），请在生成的内容中智能地说明情况，以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、紧迫但冷静，强调修复的重要性但避免引发恐慌。

# 事件JSON数据
[此处将动态插入漏洞检测JSON]

# 输出格式与内容要求
【高危漏洞通知】您好！我是您的安全助手 Bot。系统于 [清晰地写出检测时间] 发现高优先级漏洞，请在 [写出规则中设定的响应超时分钟数] 分钟内确认修复计划。
⸻
• GPT研判结论：[概括并填入AI的核心风险评估结论]
• 漏洞等级：[再次明确漏洞严重等级]
• 漏洞编号：[如果存在CVE编号则填入，如不存在则说明"暂无CVE编号"]
• 影响资产：[描述受影响资产的关键信息，包括其IP、端口和业务描述]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
立即修复
计划修复
风险评估
请及时处理，避免安全风险！`,
                
                'business_impact': `# 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的业务影响评估报告，转换为一份清晰、准确、专业的企微通知消息，以便业务负责人能快速理解风险并确认影响范围。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在，请在生成的内容中智能地说明情况，以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、关切但不引发恐慌，强调业务连续性保障。

# 事件JSON数据
[此处将动态插入业务影响评估JSON]

# 输出格式与内容要求
【业务影响确认】您好！我是您的安全助手 Bot。系统于 [清晰地写出检测时间] 检测到可能影响您业务的安全事件，请在 [写出规则中设定的响应超时分钟数] 分钟内确认影响范围。
⸻
• GPT研判结论：[概括并填入AI的核心影响评估结论]
• 威胁等级：[明确指出威胁等级]
• 受影响资产：[描述受影响资产的关键信息，包括其IP、端口和业务描述]
• 业务影响：[详细描述对业务可能的影响范围和严重程度]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
确认影响
无影响
需要支持
我们将根据您的反馈制定相应的处置方案。`,
                
                'phishing': `# 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的钓鱼攻击检测报告，转换为一份清晰、准确、专业的企微通知消息，以便受影响人员能快速理解威胁并采取正确防护措施。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在，请在生成的内容中智能地说明情况，以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、警示性但不引发恐慌，强调立即防护的重要性。

# 事件JSON数据
[此处将动态插入钓鱼攻击检测JSON]

# 输出格式与内容要求
【钓鱼事件通知】您好！我是您的安全助手 Bot。系统于 [清晰地写出检测时间] 检测到您可能遭遇钓鱼攻击，请在 [写出规则中设定的响应超时分钟数] 分钟内确认处置方式。
⸻
• GPT研判结论：[概括并填入AI的核心威胁分析结论]
• 威胁等级：[明确指出威胁等级]
• 受影响资产：[描述受影响资产的关键信息，包括其IP、端口和业务描述]
• 攻击源 IP：[描述攻击源的IP地址及其地理位置]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
立即隔离
标记误报
申请调查
请勿点击任何可疑链接，如有疑问请联系安全团队！`,
                
                'custom': `# 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的安全事件报告，转换为一份清晰、准确、专业的企微通知消息，以便相关人员能快速理解情况并做出决策。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在，请在生成的内容中智能地说明情况，以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、中性，既不过度紧张也不过于松懈，确保准确传达事件信息。

# 事件JSON数据
[此处将动态插入安全事件JSON]

# 输出格式与内容要求
【安全事件通知】您好！我是您的安全助手 Bot。系统于 [清晰地写出事件时间] 监测到一条安全事件，请在 [写出规则中设定的响应超时分钟数] 分钟内确认并选择处置方式。
⸻
• GPT研判结论：[概括并填入AI的核心分析结论]
• 威胁等级：[明确指出威胁等级]
• 受影响资产：[描述受影响资产的关键信息，包括其IP、端口和业务描述]
• 攻击源 IP：[如有攻击源则描述IP地址及地理位置，如无则说明"暂无明确攻击源"]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
确认处置
标记完成
申请协助
感谢您的配合！`
            };
            
            return templates[templateType] || templates['custom'];
        }
        
        // 添加指令行
        function addCommandRow() {
            const commandRows = document.getElementById('commandRows');
            if (commandRows) {
                const newRow = document.createElement('div');
                newRow.className = 'command-row grid grid-cols-4 gap-2 items-center';
                newRow.innerHTML = `
                    <input type="text" placeholder="指令描述" class="p-2 border border-gray-300 rounded text-xs">
                    <input type="text" placeholder="关键词" class="p-2 border border-gray-300 rounded text-xs">
                    <input type="text" placeholder="输出值" class="p-2 border border-gray-300 rounded text-xs">
                    <button class="text-red-600 hover:text-red-800 text-xs" onclick="removeCommandRow(this)">删除</button>
                `;
                commandRows.appendChild(newRow);
            }
        }
        
        // 删除指令行
        function removeCommandRow(button) {
            const row = button.closest('.command-row');
            if (row) {
                row.remove();
            }
        }

        // 获取节点类型
        function getNodeType(node) {
            if (node.classList.contains('node-trigger')) return 'trigger';
            if (node.classList.contains('node-ai')) return 'ai';
            if (node.classList.contains('node-agent')) return 'agent';
            if (node.classList.contains('node-soar')) return 'soar';
            if (node.classList.contains('node-human')) return 'human';
            if (node.classList.contains('node-logic')) return 'logic';
            if (node.classList.contains('node-comment') || node.classList.contains('node-group')) return 'comment';
            return 'unknown';
        }

        // 获取节点属性配置HTML
        function getNodePropertiesHTML(type, node) {
            const nodeTitle = node.querySelector('.font-semibold').textContent;
            
            switch(type) {
                case 'trigger':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">节点名称</label>
                                <input type="text" value="${nodeTitle}" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">触发条件</label>
                                <textarea class="w-full p-2 border border-gray-300 rounded-md h-20" placeholder="设置触发条件..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">优先级</label>
                                <select class="w-full p-2 border border-gray-300 rounded-md">
                                    <option>高</option>
                                    <option>中</option>
                                    <option>低</option>
                                </select>
                            </div>
                        </div>
                    `;
                case 'agent':
                    return `
                        <div class="space-y-4">
                            <!-- 专业说明 -->
                            <div class="bg-purple-50 border border-purple-200 rounded-md p-3">
                                <div class="flex items-center mb-1">
                                    <i class="fas fa-user-tie text-purple-600 mr-2"></i>
                                    <span class="text-sm font-medium text-purple-900">安全运营专家 - 智能联络员Agent</span>
                                </div>
                                <div class="text-xs text-purple-700">
                                    将JSON格式安全事件报告转换为清晰、准确、专业的企微通知消息，确保一线分析师快速理解并决策
                                </div>
                            </div>
                            
                            <!-- 页签导航 -->
                            <div class="border-b border-gray-200">
                                <nav class="flex space-x-6">
                                    <button id="messageTemplateTab" class="tab-button border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium">
                                        Prompt工程
                                    </button>
                                    <button id="interactionTab" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 text-sm font-medium">
                                        交互与分支
                                    </button>
                                </nav>
                            </div>
                            
                            <!-- Prompt工程页签内容 -->
                            <div id="messageTemplateContent" class="tab-content">
                        <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">从Prompt库选择</label>
                                        <select id="templateSelect" class="w-full p-2 border border-gray-300 rounded-md bg-blue-50 border-blue-200">
                                            <option value="">选择预设Prompt...</option>
                                            <option value="security_incident">[官方] 重大安全事件响应Prompt</option>
                                            <option value="asset_exposure">[官方] 业务发现新的暴露面响应Prompt</option>
                                            <option value="vulnerability">[官方] 高优先级漏洞响应闭环Prompt</option>
                                            <option value="business_impact">[官方] 业务影响确认Prompt</option>
                                            <option value="phishing">[官方] 钓鱼事件处置Prompt</option>
                                            <option value="custom">自定义Prompt</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Prompt内容</label>
                                        <textarea id="messageTemplate" class="w-full p-3 border border-gray-300 rounded-md h-48 font-mono text-sm" placeholder="选择Prompt后此处将自动填充内容..."># 角色
你是一位顶尖的安全运营专家和沟通大师。你的任务是将一份机器可读的JSON格式的安全事件报告，转换为一份清晰、准确、专业的企微通知消息，以便一线分析师能快速理解情况并做出决策。

# 任务
严格按照下方指定的"输出格式"和"内容要求"，根据提供的"[事件JSON数据]"生成内容。

# 规则
1. **忠于原文:** 所有信息都必须来自提供的JSON，严禁杜撰或猜测。
2. **智能处理空值:** 如果JSON中某个关键信息不存在（如漏洞信息），请在生成的内容中智能地说明情况（如"暂无关联漏洞信息"），以保证通知的通顺和专业性。
3. **语言风格:** 语气必须专业、冷静、紧急，但不能引发不必要的恐慌。

# 事件JSON数据
[此处将动态插入上述示例JSON]

# 输出格式与内容要求
【安全事件通知】您好！我是您的安全助手 Bot。系统于 [清晰地写出事件发生的具体时间] 监测到一条 [明确指出事件的严重等级]安全事件，请在 [写出规则中设定的响应超时分钟数] 分钟 内确认并选择处置方式（测试阶段，如有打扰敬请諒解，或需人工协助请 @信息安全部-服务号）。
⸻
• GPT研判结论：[概括并填入AI的核心研判结论]
• 威胁等级：[再次明确威胁等级]
• 受影响资产：[描述受影响资产的关键信息，包括其IP、端口和业务描述]
• 攻击源 IP：[描述攻击源的IP地址及其地理位置]
• 检测详情：[使用GPT研判的总结内容]
⸻
请回复以下任一指令（[写出规则中设定的响应超时分钟数] 分钟内有效）：
详情
一键遏制
标记完成
调查
若超时未回复，事件将进入「待人工复核」队列并持续监控。感谢配合！</textarea>
                                    </div>
                                    
                                    <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                                        <h5 class="text-sm font-medium text-blue-900 mb-2">Prompt工程说明</h5>
                                        <div class="text-xs text-blue-700 space-y-1">
                                            <div class="mb-2"><strong>JSON数据动态插入：</strong>安全事件的完整JSON将在运行时自动插入到"[事件JSON数据]"占位符位置</div>
                                            <div class="mb-2"><strong>输出格式指引：</strong>使用方括号[]标记的内容为AI需要智能提取和转换的信息，确保：</div>
                                            <div class="ml-2">• 严格忠于JSON原文，禁止杜撰</div>
                                            <div class="ml-2">• 智能处理空值或缺失字段</div>
                                            <div class="ml-2">• 保持专业安全运营语气</div>
                                            <div class="ml-2">• 根据事件类型调整语言紧急程度</div>
                                            <div class="mt-2"><strong>核心变量映射：</strong></div>
                                            <div class="ml-2">事件时间、严重等级、受影响资产、攻击源信息、GPT研判结论、检测详情、响应超时时间等</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 交互与分支页签内容 -->
                            <div id="interactionContent" class="tab-content hidden">
                                <div class="space-y-4">
                                    <div class="bg-amber-50 border border-amber-200 rounded-md p-3">
                                        <div class="flex items-center mb-1">
                                            <i class="fas fa-lightbulb text-amber-600 mr-2"></i>
                                            <span class="text-sm font-medium text-amber-900">专业设计理念</span>
                                        </div>
                                        <div class="text-xs text-amber-700">
                                            采用冷静、专业、紧急但不引发恐慌的语气，指令设计基于安全运营实战需求，确保高压环境下快速决策
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">接收人配置</label>
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">接收人类型</label>
                                                <select id="recipientType" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 text-sm">
                                                    <option value="asset_owner">资产责任人</option>
                                                    <option value="admin">管理员</option>
                                                    <option value="custom">自定义</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">具体接收人</label>
                                                <input type="text" id="recipientInput" placeholder="@用户名或角色组（当选择自定义时填写）" class="w-full p-2 border border-gray-300 rounded-md disabled:bg-gray-100 disabled:text-gray-500">
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <input type="number" value="15" class="w-20 p-2 border border-gray-300 rounded-md">
                                                <span class="text-sm text-gray-600">分钟后升级给管理员</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">通知渠道</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" checked class="mr-2">
                                        <span class="text-sm">企业微信</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2">
                                        <span class="text-sm">邮件</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-2">
                                        <span class="text-sm">短信</span>
                                    </label>
                                </div>
                            </div>
                                    
                            <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">用户指令配置</label>
                                        <div class="text-xs text-gray-500 mb-3 bg-yellow-50 p-2 rounded">
                                            💡 您在这里配置的每一条指令，都会在工作流画布的节点上生成一个对应的"输出锚点"，用于连接后续的流程。
                            </div>
                                        
                                        <div class="space-y-3">
                                            <div class="border rounded-md p-3 bg-gray-50">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-sm font-medium text-gray-700">指令配置</span>
                                                    <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="addCommandRow()">+ 添加指令</button>
                                                </div>
                                                
                                                <div class="space-y-2" id="commandRows">
                                                    <div class="command-row grid grid-cols-4 gap-2 items-center">
                                                        <input type="text" placeholder="指令描述" value="查看完整原始日志与上下文" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="关键词" value="详情" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="输出值" value="get_details" class="p-2 border border-gray-300 rounded text-xs">
                                                        <button class="text-red-600 hover:text-red-800 text-xs" onclick="removeCommandRow(this)">删除</button>
                                                    </div>
                                                    
                                                    <div class="command-row grid grid-cols-4 gap-2 items-center">
                                                        <input type="text" placeholder="指令描述" value="指派处置Agent封禁恶意实体" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="关键词" value="一键遏制" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="输出值" value="containment_approved" class="p-2 border border-gray-300 rounded text-xs">
                                                        <button class="text-red-600 hover:text-red-800 text-xs" onclick="removeCommandRow(this)">删除</button>
                                                    </div>
                                                    
                                                    <div class="command-row grid grid-cols-4 gap-2 items-center">
                                                        <input type="text" placeholder="指令描述" value="直接标记完成该事件" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="关键词" value="标记完成" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="输出值" value="marked_as_done" class="p-2 border border-gray-300 rounded text-xs">
                                                        <button class="text-red-600 hover:text-red-800 text-xs" onclick="removeCommandRow(this)">删除</button>
                                                    </div>
                                                    
                                                    <div class="command-row grid grid-cols-4 gap-2 items-center">
                                                        <input type="text" placeholder="指令描述" value="指派调查Agent深入溯源调查" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="关键词" value="调查" class="p-2 border border-gray-300 rounded text-xs">
                                                        <input type="text" placeholder="输出值" value="re_investigate" class="p-2 border border-gray-300 rounded text-xs">
                                                        <button class="text-red-600 hover:text-red-800 text-xs" onclick="removeCommandRow(this)">删除</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-green-50 border border-green-200 rounded-md p-3">
                                        <h5 class="text-sm font-medium text-green-900 mb-2">输出锚点预览</h5>
                                        <div class="text-xs text-green-700 space-y-1">
                                            <div>• <code>get_details</code> - 查看详情分支</div>
                                            <div>• <code>containment_approved</code> - 一键遏制分支</div>
                                            <div>• <code>marked_as_done</code> - 标记完成分支</div>
                                            <div>• <code>re_investigate</code> - 调查分支</div>
                                        </div>
                                        <div class="mt-2 text-xs text-green-600">
                                            💡 基于专业安全运营要求，指令简化为4个核心操作，确保一线分析师能快速决策
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                case 'ai':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">AI模型</label>
                                <select class="w-full p-2 border border-gray-300 rounded-md">
                                    <option>GPT-4</option>
                                    <option>Claude-3</option>
                                    <option>文心一言</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">自定义Prompt</label>
                                <textarea class="w-full p-2 border border-gray-300 rounded-md h-32" placeholder="输入自定义提示词..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">知识库</label>
                                <select class="w-full p-2 border border-gray-300 rounded-md">
                                    <option>安全事件库</option>
                                    <option>威胁情报库</option>
                                    <option>资产信息库</option>
                                </select>
                            </div>
                        </div>
                    `;
                case 'soar':
                    if (nodeTitle.includes('工单')) {
                        return `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">工单系统</label>
                                    <select class="w-full p-2 border border-gray-300 rounded-md">
                                        <option>ServiceNow</option>
                                        <option>Jira Service Desk</option>
                                        <option>企业内部工单系统</option>
                                        <option>钉钉工单</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">工单类型</label>
                                    <select class="w-full p-2 border border-gray-300 rounded-md">
                                        <option>安全事件处置</option>
                                        <option>漏洞修复</option>
                                        <option>系统维护</option>
                                        <option>权限申请</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">优先级</label>
                                    <select class="w-full p-2 border border-gray-300 rounded-md">
                                        <option>紧急</option>
                                        <option>高</option>
                                        <option>中</option>
                                        <option>低</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">分配给</label>
                                    <input type="text" placeholder="用户名或角色组" class="w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">工单模板</label>
                                    <textarea class="w-full p-2 border border-gray-300 rounded-md h-20" placeholder="工单描述模板...">${nodeTitle.includes('工单') ? '安全事件: {{事件ID}}\n事件类型: {{事件类型}}\n影响资产: {{资产列表}}\n建议处置: {{AI建议}}' : ''}</textarea>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    <label class="text-sm text-gray-700">自动创建工单</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" class="mr-2">
                                    <label class="text-sm text-gray-700">等待工单完成后继续</label>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Playbook名称</label>
                                    <input type="text" value="${nodeTitle}" class="w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">SOAR平台</label>
                                    <select class="w-full p-2 border border-gray-300 rounded-md">
                                        <option>Phantom</option>
                                        <option>Demisto</option>
                                        <option>IBM Resilient</option>
                                        <option>自定义SOAR</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">执行参数</label>
                                    <textarea class="w-full p-2 border border-gray-300 rounded-md h-20" placeholder="JSON格式参数..."></textarea>
                                </div>
                            </div>
                        `;
                    }
                case 'comment':
                    return `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">说明标题</label>
                                <input type="text" value="${nodeTitle}" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">说明内容</label>
                                <textarea class="w-full p-2 border border-gray-300 rounded-md h-32" placeholder="输入详细说明..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">背景颜色</label>
                                <select class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="yellow">黄色</option>
                                    <option value="blue">蓝色</option>
                                    <option value="green">绿色</option>
                                    <option value="red">红色</option>
                                    <option value="gray">灰色</option>
                                </select>
                            </div>
                        </div>
                    `;
                default:
                    return `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">节点名称</label>
                                <input type="text" value="${nodeTitle}" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                                <textarea class="w-full p-2 border border-gray-300 rounded-md h-20" placeholder="节点描述..."></textarea>
                            </div>
                        </div>
                    `;
            }
        }

        // 开始调试模式
        function startDebugMode() {
            isDebugMode = true;
            document.getElementById('debugModal').classList.add('hidden');
            
            // 高亮显示执行路径
            const executionPath = [
                'start-node', 'agent-node', 'investigate-agent', 
                'disposal-agent', 'ticket-node', 'soar-playbook', 'ai-report'
            ];
            
            let currentStep = 0;
            
            function highlightNextStep() {
                // 移除之前的高亮
                document.querySelectorAll('.debug-highlight').forEach(el => {
                    el.classList.remove('debug-highlight');
                });
                
                if (currentStep < executionPath.length) {
                    const currentNode = document.getElementById(executionPath[currentStep]);
                    if (currentNode) {
                        currentNode.classList.add('debug-highlight');
                        
                        // 模拟处理时间
                        setTimeout(() => {
                            currentStep++;
                            highlightNextStep();
                        }, 2000);
                    }
                } else {
                    // 调试完成
                    isDebugMode = false;
                    showDebugComplete();
                }
            }
            
            highlightNextStep();
        }

        // 显示调试完成
        function showDebugComplete() {
            alert('工作流调试完成！\n\n执行路径：\n1. 触发重大安全事件\n2. 联络员Agent推送通知\n3. 调查溯源Agent分析\n4. 处置封堵Agent执行\n5. 创建工单记录\n6. SOAR引擎调用\n7. AI生成闭环报告');
        }

        // 保存工作流
        function saveWorkflow() {
            const workflow = {
                nodes: [],
                connections: []
            };
            
            // 收集节点信息
            document.querySelectorAll('.workflow-node').forEach(node => {
                workflow.nodes.push({
                    id: node.id,
                    type: getNodeType(node),
                    position: {
                        x: parseInt(node.style.left),
                        y: parseInt(node.style.top)
                    },
                    title: node.querySelector('.font-semibold').textContent
                });
            });
            
            // 收集连接信息
            jsPlumbInstance.getAllConnections().forEach(conn => {
                workflow.connections.push({
                    source: conn.sourceId,
                    target: conn.targetId
                });
            });
            
            console.log('工作流已保存:', workflow);
            alert('工作流保存成功！');
        }

        // 发布工作流
        function publishWorkflow() {
            if (confirm('确定要发布此工作流吗？发布后将开始监控和自动执行。')) {
                alert('工作流发布成功！\n\n状态：已激活\n监控：24/7\n预计响应时间：< 5分钟');
            }
        }

        // 更新节点计数
        function updateNodeCount() {
            const nodeCount = document.querySelectorAll('.workflow-node').length;
            document.getElementById('nodeCount').textContent = nodeCount;
        }

        // 更新连接计数
        function updateConnectionCount() {
            const connectionCount = jsPlumbInstance.getAllConnections().length;
            document.getElementById('connectionCount').textContent = connectionCount;
        }

        // 断开节点连接
        function disconnectNode(node) {
            const connections = jsPlumbInstance.getAllConnections();
            const nodeId = node.id;
            
            connections.forEach(conn => {
                if (conn.sourceId === nodeId || conn.targetId === nodeId) {
                    jsPlumbInstance.deleteConnection(conn);
                }
            });
            
            updateConnectionCount();
        }

        // 获取节点子类型
        function getNodeSubtype(node) {
            const title = node.querySelector('.font-semibold').textContent;
            
            // 根据标题判断子类型（简单实现）
            if (title.includes('告警')) return 'alert';
            if (title.includes('事件')) return 'event';
            if (title.includes('Webhook')) return 'webhook';
            if (title.includes('调查')) return 'investigate';
            if (title.includes('处置') || title.includes('实体')) return 'disposal';
            if (title.includes('自定义')) return 'custom';
            if (title.includes('联络')) return 'contact';
            if (title.includes('Playbook')) return 'playbook';
            if (title.includes('工单')) return 'ticket';
            if (title.includes('确认')) return 'confirm';
            if (title.includes('条件')) return 'condition';
            if (title.includes('文字')) return 'text';
            if (title.includes('分组')) return 'group';
            
            return 'default';
        }

        // ============= 模板商店功能 =============
        
        // 工作流模板定义
        const workflowTemplates = {
            'demo-agent-contact': {
                name: '演示联络员Agent',
                description: '智能安全运营专家，将JSON事件转换为专业企微通知消息',
                nodes: [
                    { id: 'trigger-demo', type: 'trigger', subtype: 'alert', title: '安全事件触发', x: 100, y: 200, icon: 'exclamation-triangle', color: 'red' },
                    { id: 'agent-demo', type: 'agent', subtype: 'contact', title: '联络员Agent', x: 400, y: 200, icon: 'user-tie', color: 'purple' },
                    { id: 'detail-demo', type: 'ai', subtype: 'custom', title: '详情信息', x: 700, y: 100, icon: 'info-circle', color: 'blue' },
                    { id: 'contain-demo', type: 'soar', subtype: 'playbook', title: '一键遏制', x: 700, y: 180, icon: 'shield-alt', color: 'orange' },
                    { id: 'complete-demo', type: 'soar', subtype: 'ticket', title: '标记完成', x: 700, y: 260, icon: 'check-circle', color: 'green' },
                    { id: 'investigate-demo', type: 'ai', subtype: 'investigate', title: '调查分析', x: 700, y: 340, icon: 'search', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-demo', target: 'agent-demo' },
                    { source: 'agent-demo', target: 'detail-demo', sourceAnchor: 'get_details' },
                    { source: 'agent-demo', target: 'contain-demo', sourceAnchor: 'containment_approved' },
                    { source: 'agent-demo', target: 'complete-demo', sourceAnchor: 'marked_as_done' },
                    { source: 'agent-demo', target: 'investigate-demo', sourceAnchor: 're_investigate' }
                ]
            },
            'internet-attack-block': {
                name: '互联网攻击自动化阻断流程',
                description: '发生外到内真实攻击告警，实体分析后确认是否封堵',
                nodes: [
                    { id: 'trigger-1', type: 'trigger', subtype: 'alert', title: '互联网攻击告警', x: 100, y: 200, icon: 'exclamation-triangle', color: 'red' },
                    { id: 'ai-analysis-1', type: 'ai', subtype: 'investigate', title: '威胁分析Agent', x: 400, y: 200, icon: 'search', color: 'blue' },
                    { id: 'condition-1', type: 'logic', subtype: 'condition', title: '威胁等级判断', x: 700, y: 200, icon: 'question', color: 'gray' },
                    { id: 'auto-block-1', type: 'soar', subtype: 'playbook', title: '自动封堵Playbook', x: 1000, y: 100, icon: 'shield-alt', color: 'green' },
                    { id: 'human-confirm-1', type: 'human', subtype: 'confirm', title: '人工确认封堵', x: 1000, y: 300, icon: 'user-check', color: 'red' },
                    { id: 'report-1', type: 'ai', subtype: 'custom', title: 'AI生成处置报告', x: 1300, y: 200, icon: 'file-alt', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-1', target: 'ai-analysis-1' },
                    { source: 'ai-analysis-1', target: 'condition-1' },
                    { source: 'condition-1', target: 'auto-block-1' },
                    { source: 'condition-1', target: 'human-confirm-1' },
                    { source: 'auto-block-1', target: 'report-1' },
                    { source: 'human-confirm-1', target: 'report-1' }
                ]
            },
            'security-incident-response': {
                name: '重大安全事件应急响应流程',
                description: '触发重要的安全事件后，自动化调查、分析、确认与响应流程',
                nodes: [
                    { id: 'trigger-2', type: 'trigger', subtype: 'alert', title: '重大安全事件触发', x: 100, y: 200, icon: 'fire', color: 'red' },
                    { id: 'agent-notify-2', type: 'agent', subtype: 'contact', title: '智能联络员Agent', x: 400, y: 200, icon: 'user-tie', color: 'purple' },
                    { id: 'detail-report-2', type: 'ai', subtype: 'custom', title: '详细信息报告', x: 700, y: 80, icon: 'file-alt', color: 'blue' },
                    { id: 'investigate-2', type: 'ai', subtype: 'investigate', title: '调查溯源Agent', x: 700, y: 160, icon: 'search', color: 'blue' },
                    { id: 'disposal-2', type: 'ai', subtype: 'disposal', title: '实体处置Agent', x: 700, y: 240, icon: 'shield-alt', color: 'green' },
                    { id: 'mark-done-2', type: 'soar', subtype: 'ticket', title: '标记事件完成', x: 700, y: 320, icon: 'check-circle', color: 'green' },
                    { id: 'soar-2', type: 'soar', subtype: 'playbook', title: 'SOAR处置引擎', x: 1000, y: 240, icon: 'cogs', color: 'orange' },
                    { id: 'ticket-2', type: 'soar', subtype: 'ticket', title: '创建处置工单', x: 1000, y: 320, icon: 'ticket-alt', color: 'orange' },
                    { id: 'report-2', type: 'ai', subtype: 'custom', title: 'AI闭环报告', x: 1300, y: 240, icon: 'file-alt', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-2', target: 'agent-notify-2' },
                    { source: 'agent-notify-2', target: 'detail-report-2', sourceAnchor: 'get_details' },
                    { source: 'agent-notify-2', target: 'disposal-2', sourceAnchor: 'containment_approved' },
                    { source: 'agent-notify-2', target: 'mark-done-2', sourceAnchor: 'marked_as_done' },
                    { source: 'agent-notify-2', target: 'investigate-2', sourceAnchor: 're_investigate' },
                    { source: 'investigate-2', target: 'disposal-2' },
                    { source: 'disposal-2', target: 'soar-2' },
                    { source: 'disposal-2', target: 'ticket-2' },
                    { source: 'soar-2', target: 'report-2' },
                    { source: 'ticket-2', target: 'report-2' }
                ]
            },
            'phishing-notification': {
                name: '钓鱼事件通知与闭环流程',
                description: '用户点击钓鱼邮件，确认为真后，推送终端用户提醒并获得回复',
                nodes: [
                    { id: 'trigger-3', type: 'trigger', subtype: 'event', title: '钓鱼事件触发', x: 100, y: 200, icon: 'fish', color: 'yellow' },
                    { id: 'ai-verify-3', type: 'ai', subtype: 'investigate', title: 'AI验证钓鱼真实性', x: 400, y: 200, icon: 'search', color: 'blue' },
                    { id: 'condition-3', type: 'logic', subtype: 'condition', title: '钓鱼确认判断', x: 700, y: 200, icon: 'question', color: 'gray' },
                    { id: 'user-notify-3', type: 'agent', subtype: 'contact', title: '用户安全提醒', x: 1000, y: 200, icon: 'bell', color: 'purple' },
                    { id: 'training-3', type: 'soar', subtype: 'playbook', title: '安全意识培训', x: 1300, y: 100, icon: 'graduation-cap', color: 'orange' },
                    { id: 'isolation-3', type: 'soar', subtype: 'playbook', title: '邮箱隔离处置', x: 1300, y: 300, icon: 'lock', color: 'orange' },
                    { id: 'report-3', type: 'ai', subtype: 'custom', title: '钓鱼事件报告', x: 1600, y: 200, icon: 'file-alt', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-3', target: 'ai-verify-3' },
                    { source: 'ai-verify-3', target: 'condition-3' },
                    { source: 'condition-3', target: 'user-notify-3' },
                    { source: 'user-notify-3', target: 'training-3' },
                    { source: 'user-notify-3', target: 'isolation-3' },
                    { source: 'training-3', target: 'report-3' },
                    { source: 'isolation-3', target: 'report-3' }
                ]
            },
            'executive-security-incident': {
                name: '高管安全事件专项流程',
                description: '高管用户的安全事件，推送管理员确认后再自动化推送通知确认',
                nodes: [
                    { id: 'trigger-4', type: 'trigger', subtype: 'alert', title: '高管安全事件', x: 100, y: 200, icon: 'crown', color: 'purple' },
                    { id: 'classify-4', type: 'ai', subtype: 'investigate', title: 'AI事件分级', x: 400, y: 200, icon: 'layer-group', color: 'blue' },
                    { id: 'admin-approval-4', type: 'human', subtype: 'confirm', title: '管理员预审批', x: 700, y: 200, icon: 'user-shield', color: 'red' },
                    { id: 'executive-notify-4', type: 'agent', subtype: 'contact', title: '高管通知确认', x: 1000, y: 200, icon: 'user-tie', color: 'purple' },
                    { id: 'escalate-4', type: 'soar', subtype: 'playbook', title: '事件升级流程', x: 1300, y: 100, icon: 'arrow-up', color: 'orange' },
                    { id: 'response-4', type: 'soar', subtype: 'playbook', title: '高优先级响应', x: 1300, y: 300, icon: 'fire-alt', color: 'orange' },
                    { id: 'report-4', type: 'ai', subtype: 'custom', title: '高管事件报告', x: 1600, y: 200, icon: 'file-alt', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-4', target: 'classify-4' },
                    { source: 'classify-4', target: 'admin-approval-4' },
                    { source: 'admin-approval-4', target: 'executive-notify-4' },
                    { source: 'executive-notify-4', target: 'escalate-4' },
                    { source: 'executive-notify-4', target: 'response-4' },
                    { source: 'escalate-4', target: 'report-4' },
                    { source: 'response-4', target: 'report-4' }
                ]
            },
            'core-asset-exposure': {
                name: '核心资产发现新的互联网暴露',
                description: '对于设定的核心资产，发现了新的关键暴露面',
                nodes: [
                    { id: 'trigger-5', type: 'trigger', subtype: 'event', title: '新暴露面发现', x: 100, y: 200, icon: 'globe', color: 'cyan' },
                    { id: 'asset-classify-5', type: 'ai', subtype: 'investigate', title: '资产重要性分析', x: 400, y: 200, icon: 'server', color: 'blue' },
                    { id: 'risk-assess-5', type: 'ai', subtype: 'investigate', title: '风险评估Agent', x: 700, y: 200, icon: 'exclamation-triangle', color: 'blue' },
                    { id: 'owner-notify-5', type: 'agent', subtype: 'contact', title: '资产负责人通知', x: 1000, y: 100, icon: 'user', color: 'purple' },
                    { id: 'auto-scan-5', type: 'soar', subtype: 'playbook', title: '自动安全扫描', x: 1000, y: 300, icon: 'search', color: 'orange' },
                    { id: 'remediate-5', type: 'soar', subtype: 'playbook', title: '暴露面收敛', x: 1300, y: 200, icon: 'shield-alt', color: 'orange' },
                    { id: 'report-5', type: 'ai', subtype: 'custom', title: '暴露面分析报告', x: 1600, y: 200, icon: 'chart-bar', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-5', target: 'asset-classify-5' },
                    { source: 'asset-classify-5', target: 'risk-assess-5' },
                    { source: 'risk-assess-5', target: 'owner-notify-5' },
                    { source: 'risk-assess-5', target: 'auto-scan-5' },
                    { source: 'owner-notify-5', target: 'remediate-5' },
                    { source: 'auto-scan-5', target: 'remediate-5' },
                    { source: 'remediate-5', target: 'report-5' }
                ]
            },
            'agent-coverage-monitoring': {
                name: 'Agent覆盖率监控与补齐流程',
                description: '检测到新的新的安全事件但主机未安装Agent',
                nodes: [
                    { id: 'trigger-6', type: 'trigger', subtype: 'alert', title: '无Agent主机告警', x: 100, y: 200, icon: 'exclamation-triangle', color: 'green' },
                    { id: 'host-identify-6', type: 'ai', subtype: 'investigate', title: '主机身份识别', x: 400, y: 200, icon: 'desktop', color: 'blue' },
                    { id: 'coverage-check-6', type: 'ai', subtype: 'investigate', title: 'Agent覆盖率检查', x: 700, y: 200, icon: 'chart-line', color: 'blue' },
                    { id: 'admin-notify-6', type: 'agent', subtype: 'contact', title: '管理员通知', x: 1000, y: 100, icon: 'user-cog', color: 'purple' },
                    { id: 'auto-deploy-6', type: 'soar', subtype: 'playbook', title: '自动部署Agent', x: 1000, y: 300, icon: 'download', color: 'orange' },
                    { id: 'verify-6', type: 'ai', subtype: 'investigate', title: '部署结果验证', x: 1300, y: 200, icon: 'check-circle', color: 'blue' },
                    { id: 'report-6', type: 'ai', subtype: 'custom', title: '覆盖率报告', x: 1600, y: 200, icon: 'chart-pie', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-6', target: 'host-identify-6' },
                    { source: 'host-identify-6', target: 'coverage-check-6' },
                    { source: 'coverage-check-6', target: 'admin-notify-6' },
                    { source: 'coverage-check-6', target: 'auto-deploy-6' },
                    { source: 'admin-notify-6', target: 'verify-6' },
                    { source: 'auto-deploy-6', target: 'verify-6' },
                    { source: 'verify-6', target: 'report-6' }
                ]
            },
            'high-risk-vulnerability': {
                name: '高可利用漏洞确认与修复流程',
                description: '检测到高可利用漏洞，推送人工确认后进行流程化修复',
                nodes: [
                    { id: 'trigger-7', type: 'trigger', subtype: 'alert', title: '高危漏洞发现', x: 100, y: 200, icon: 'bug', color: 'red' },
                    { id: 'vuln-analysis-7', type: 'ai', subtype: 'investigate', title: '漏洞影响分析', x: 400, y: 200, icon: 'search', color: 'blue' },
                    { id: 'exploit-check-7', type: 'ai', subtype: 'investigate', title: '可利用性评估', x: 700, y: 200, icon: 'shield-alt', color: 'blue' },
                    { id: 'security-confirm-7', type: 'human', subtype: 'confirm', title: '安全团队确认', x: 1000, y: 100, icon: 'user-check', color: 'red' },
                    { id: 'emergency-patch-7', type: 'soar', subtype: 'playbook', title: '紧急修复流程', x: 1000, y: 300, icon: 'tools', color: 'orange' },
                    { id: 'ticket-create-7', type: 'soar', subtype: 'ticket', title: '创建修复工单', x: 1300, y: 200, icon: 'ticket-alt', color: 'orange' },
                    { id: 'verify-patch-7', type: 'ai', subtype: 'investigate', title: '修复结果验证', x: 1600, y: 200, icon: 'check-double', color: 'blue' },
                    { id: 'report-7', type: 'ai', subtype: 'custom', title: '漏洞修复报告', x: 1900, y: 200, icon: 'file-medical', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-7', target: 'vuln-analysis-7' },
                    { source: 'vuln-analysis-7', target: 'exploit-check-7' },
                    { source: 'exploit-check-7', target: 'security-confirm-7' },
                    { source: 'exploit-check-7', target: 'emergency-patch-7' },
                    { source: 'security-confirm-7', target: 'ticket-create-7' },
                    { source: 'emergency-patch-7', target: 'ticket-create-7' },
                    { source: 'ticket-create-7', target: 'verify-patch-7' },
                    { source: 'verify-patch-7', target: 'report-7' }
                ]
            },
            'vulnerability-lifecycle': {
                name: '漏洞生命周期管理流程',
                description: '完整的漏洞管理流程，包含责任人推送等',
                nodes: [
                    { id: 'trigger-8', type: 'trigger', subtype: 'event', title: '漏洞扫描发现', x: 100, y: 200, icon: 'search', color: 'indigo' },
                    { id: 'classify-8', type: 'ai', subtype: 'investigate', title: '漏洞分类分级', x: 400, y: 200, icon: 'layer-group', color: 'blue' },
                    { id: 'assign-8', type: 'ai', subtype: 'investigate', title: '责任人分配', x: 700, y: 200, icon: 'user-tag', color: 'blue' },
                    { id: 'owner-notify-8', type: 'agent', subtype: 'contact', title: '责任人通知', x: 1000, y: 100, icon: 'bell', color: 'purple' },
                    { id: 'sla-monitor-8', type: 'soar', subtype: 'playbook', title: 'SLA监控提醒', x: 1000, y: 300, icon: 'clock', color: 'orange' },
                    { id: 'patch-track-8', type: 'soar', subtype: 'ticket', title: '修复进度跟踪', x: 1300, y: 200, icon: 'tasks', color: 'orange' },
                    { id: 'verify-close-8', type: 'ai', subtype: 'investigate', title: '修复验证闭环', x: 1600, y: 200, icon: 'check-circle', color: 'blue' },
                    { id: 'report-8', type: 'ai', subtype: 'custom', title: '漏洞管理报告', x: 1900, y: 200, icon: 'chart-line', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-8', target: 'classify-8' },
                    { source: 'classify-8', target: 'assign-8' },
                    { source: 'assign-8', target: 'owner-notify-8' },
                    { source: 'assign-8', target: 'sla-monitor-8' },
                    { source: 'owner-notify-8', target: 'patch-track-8' },
                    { source: 'sla-monitor-8', target: 'patch-track-8' },
                    { source: 'patch-track-8', target: 'verify-close-8' },
                    { source: 'verify-close-8', target: 'report-8' }
                ]
            },
            'internet-exposure-closure': {
                name: '互联网暴露资产端口闭环流程',
                description: '新增互联网暴露端口或服务',
                nodes: [
                    { id: 'trigger-9', type: 'trigger', subtype: 'event', title: '新暴露端口发现', x: 100, y: 200, icon: 'globe', color: 'teal' },
                    { id: 'port-analyze-9', type: 'ai', subtype: 'investigate', title: '端口服务分析', x: 400, y: 200, icon: 'network-wired', color: 'blue' },
                    { id: 'business-check-9', type: 'ai', subtype: 'investigate', title: '业务合理性检查', x: 700, y: 200, icon: 'balance-scale', color: 'blue' },
                    { id: 'owner-confirm-9', type: 'human', subtype: 'confirm', title: '负责人确认', x: 1000, y: 100, icon: 'user-check', color: 'red' },
                    { id: 'auto-close-9', type: 'soar', subtype: 'playbook', title: '自动端口关闭', x: 1000, y: 300, icon: 'lock', color: 'orange' },
                    { id: 'verify-9', type: 'ai', subtype: 'investigate', title: '关闭结果验证', x: 1300, y: 200, icon: 'check-circle', color: 'blue' },
                    { id: 'report-9', type: 'ai', subtype: 'custom', title: '暴露面收敛报告', x: 1600, y: 200, icon: 'file-alt', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-9', target: 'port-analyze-9' },
                    { source: 'port-analyze-9', target: 'business-check-9' },
                    { source: 'business-check-9', target: 'owner-confirm-9' },
                    { source: 'business-check-9', target: 'auto-close-9' },
                    { source: 'owner-confirm-9', target: 'verify-9' },
                    { source: 'auto-close-9', target: 'verify-9' },
                    { source: 'verify-9', target: 'report-9' }
                ]
            },
            'weak-password-response': {
                name: '弱口令风险自动响应流程',
                description: '探测到重要弱口令并生成安全事件',
                nodes: [
                    { id: 'trigger-10', type: 'trigger', subtype: 'alert', title: '弱口令发现', x: 100, y: 200, icon: 'key', color: 'amber' },
                    { id: 'account-analyze-10', type: 'ai', subtype: 'investigate', title: '账户重要性分析', x: 400, y: 200, icon: 'user-shield', color: 'blue' },
                    { id: 'risk-level-10', type: 'ai', subtype: 'investigate', title: '风险等级评估', x: 700, y: 200, icon: 'exclamation-triangle', color: 'blue' },
                    { id: 'user-notify-10', type: 'agent', subtype: 'contact', title: '用户强制修改通知', x: 1000, y: 100, icon: 'bell', color: 'purple' },
                    { id: 'auto-disable-10', type: 'soar', subtype: 'playbook', title: '高危账户自动禁用', x: 1000, y: 300, icon: 'ban', color: 'orange' },
                    { id: 'password-policy-10', type: 'soar', subtype: 'playbook', title: '密码策略强化', x: 1300, y: 200, icon: 'shield-alt', color: 'orange' },
                    { id: 'compliance-10', type: 'ai', subtype: 'custom', title: '合规性检查报告', x: 1600, y: 200, icon: 'clipboard-check', color: 'blue' }
                ],
                connections: [
                    { source: 'trigger-10', target: 'account-analyze-10' },
                    { source: 'account-analyze-10', target: 'risk-level-10' },
                    { source: 'risk-level-10', target: 'user-notify-10' },
                    { source: 'risk-level-10', target: 'auto-disable-10' },
                    { source: 'user-notify-10', target: 'password-policy-10' },
                    { source: 'auto-disable-10', target: 'password-policy-10' },
                    { source: 'password-policy-10', target: 'compliance-10' }
                ]
            }
        };

        // 模板商店相关函数已移除，现在使用页面切换方式

        // 加载模板
        function loadTemplate(templateId) {
            const template = workflowTemplates[templateId];
            if (!template) {
                alert('模板不存在！');
                return;
            }

            console.log(`开始加载模板: ${template.name}`);
            
            // 清空现有工作流
            clearWorkflow();
            
            // 创建新节点
            template.nodes.forEach(nodeData => {
                createTemplateNode(nodeData);
            });

            // 等待节点创建完成后再创建连接
            setTimeout(() => {
                console.log('开始创建连接...');
                template.connections.forEach((conn, index) => {
                    if (conn.sourceAnchor) {
                        console.log(`创建连接 ${index + 1}: ${conn.source} -> ${conn.target} (锚点: ${conn.sourceAnchor})`);
                        connectNodes(conn.source, conn.target, conn.sourceAnchor);
                    } else {
                    console.log(`创建连接 ${index + 1}: ${conn.source} -> ${conn.target}`);
                    connectNodes(conn.source, conn.target);
                    }
                });
                
                // 更新计数
                updateNodeCount();
                updateConnectionCount();
                
                // 自动适应屏幕到所有节点
                setTimeout(() => {
                    console.log('自动适应屏幕...');
                    fitToScreen();
                }, 300);
            }, 800);
        }

        // 清空工作流
        function clearWorkflow() {
            // 清除所有连接
            jsPlumbInstance.deleteEveryConnection();
            
            // 清除所有节点
            const nodes = document.querySelectorAll('.workflow-node');
            nodes.forEach(node => {
                jsPlumbInstance.remove(node);
            });
            
            // 清除选中状态
            selectedNode = null;
            document.getElementById('propertiesPanel').classList.add('hidden');
        }

        // 创建模板节点
        function createTemplateNode(nodeData) {
            console.log(`创建模板节点: ${nodeData.id} - ${nodeData.title}`);
            
            const nodeId = nodeData.id;
            const nodeClass = `node-${nodeData.type}`;
            const iconClass = `fas fa-${nodeData.icon}`;
            const colorClass = getColorClass(nodeData.color);

            const nodeHtml = `
                <div id="${nodeId}" class="workflow-node draggable-node ${nodeClass} bg-white rounded-lg shadow-md p-4 absolute" 
                     style="left: ${nodeData.x}px; top: ${nodeData.y}px; width: 200px;">
                    <div class="flex items-center mb-2">
                        <i class="${iconClass} ${colorClass} mr-2"></i>
                        <span class="font-semibold text-sm">${nodeData.title}</span>
                    </div>
                    <div class="text-xs text-gray-500">${getNodeTypeLabel(nodeData.type, nodeData.subtype)}</div>
                </div>
            `;

            const container = document.getElementById('workflow-container');
            if (!container) {
                console.error('找不到工作流容器元素');
                return;
            }
            
            container.insertAdjacentHTML('beforeend', nodeHtml);
            
            const node = document.getElementById(nodeId);
            if (!node) {
                console.error(`创建的节点 ${nodeId} 未找到`);
                return;
            }
            
            console.log(`节点 ${nodeId} 创建成功`);
            
            // 确保jsPlumb实例存在
            if (!jsPlumbInstance) {
                console.error('jsPlumb实例不存在，尝试重新初始化');
                initJsPlumb();
            }
            
            // 使节点可拖拽
            if (jsPlumbInstance) {
                jsPlumbInstance.draggable(node);
                console.log(`节点 ${nodeId} 设置为可拖拽`);
                
                // 添加连接点
                setTimeout(() => {
                    addEndpoints(node);
                    console.log(`节点 ${nodeId} 连接点添加完成`);
                }, 50);
            } else {
                console.error(`无法设置节点 ${nodeId} 为可拖拽：jsPlumb实例不存在`);
            }
            
            // 添加事件监听器
            setupNodeEvents(node);
        }

        // 获取颜色类
        function getColorClass(color) {
            const colorMap = {
                'red': 'text-red-500',
                'blue': 'text-blue-500',
                'green': 'text-green-500',
                'yellow': 'text-yellow-500',
                'purple': 'text-purple-500',
                'orange': 'text-orange-500',
                'gray': 'text-gray-500',
                'cyan': 'text-cyan-500',
                'indigo': 'text-indigo-500',
                'teal': 'text-teal-500',
                'amber': 'text-amber-500'
            };
            return colorMap[color] || 'text-gray-500';
        }

        // 获取节点类型标签
        function getNodeTypeLabel(type, subtype) {
            const labels = {
                'trigger': { 'alert': '告警触发器', 'event': '事件触发器', 'webhook': 'Webhook触发器' },
                'ai': { 'investigate': '调查分析', 'disposal': '处置决策', 'custom': '自定义AI' },
                'agent': { 'contact': '联络通知' },
                'soar': { 'playbook': 'SOAR剧本', 'ticket': '工单系统' },
                'human': { 'confirm': '人工确认' },
                'logic': { 'condition': '条件判断' }
            };
            return labels[type]?.[subtype] || `${type}-${subtype}`;
        }

        // 连接两个节点（支持特定锚点连接）
        function connectNodes(sourceId, targetId, sourceAnchor = null) {
            const sourceNode = document.getElementById(sourceId);
            const targetNode = document.getElementById(targetId);
            
            console.log(`尝试连接节点: ${sourceId} -> ${targetId}`, sourceAnchor ? `(锚点: ${sourceAnchor})` : '');
            console.log('源节点存在:', !!sourceNode);
            console.log('目标节点存在:', !!targetNode);
            console.log('jsPlumb实例存在:', !!jsPlumbInstance);
            
            if (sourceNode && targetNode && jsPlumbInstance) {
                try {
                    let connectionConfig;
                    
                    // 如果指定了源锚点，使用特定锚点连接
                    if (sourceAnchor && sourceNode.classList.contains('node-agent')) {
                        connectionConfig = {
                            source: sourceId,
                            target: targetId,
                            sourceEndpoint: sourceId + "-" + sourceAnchor,
                            targetEndpoint: targetId + "-target",
                            endpoint: "Dot",
                            paintStyle: { stroke: "#8b5cf6", strokeWidth: 2 },
                            hoverPaintStyle: { stroke: "#7c3aed", strokeWidth: 3 },
                            connector: ["Bezier", { curviness: 80 }],
                            overlays: [
                                ["Arrow", { location: 1, width: 20, length: 20 }],
                                ["Label", {
                                    label: getAnchorLabel(sourceAnchor),
                                    location: 0.7,
                                    cssClass: "connection-label text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded shadow-sm",
                                    id: "label-" + sourceAnchor
                                }]
                            ]
                        };
                    } else {
                        // 标准连接
                        connectionConfig = {
                        source: sourceId,
                        target: targetId,
                        anchor: ["Right", "Left"],
                        endpoint: "Dot",
                        paintStyle: { stroke: "#64748b", strokeWidth: 2 },
                        hoverPaintStyle: { stroke: "#1e40af", strokeWidth: 3 },
                            connector: ["Bezier", { curviness: 80 }],
                        overlays: [["Arrow", { location: 1, width: 20, length: 20 }]]
                        };
                    }
                    
                    const connection = jsPlumbInstance.connect(connectionConfig);
                    
                    if (connection) {
                        console.log(`成功创建连接: ${sourceId} -> ${targetId}`, sourceAnchor ? `(锚点: ${sourceAnchor})` : '');
                    } else {
                        console.error(`连接创建失败: ${sourceId} -> ${targetId}`);
                    }
                } catch (error) {
                    console.error(`连接创建异常: ${sourceId} -> ${targetId}`, error);
                }
            } else {
                console.error(`连接创建条件不满足: 源节点=${!!sourceNode}, 目标节点=${!!targetNode}, jsPlumb=${!!jsPlumbInstance}`);
            }
        }
        
        // 获取锚点标签
        function getAnchorLabel(anchorName) {
            const labels = {
                'get_details': '详情',
                'containment_approved': '遏制',
                'marked_as_done': '完成',
                're_investigate': '调查'
            };
            return labels[anchorName] || anchorName;
        }

        // ============= 缺失函数补充 =============
        
        // 为节点添加连接点
        function addEndpoints(node) {
            if (!jsPlumbInstance || !node) return;
            
            // 添加输出端点（右侧，绿色）
            jsPlumbInstance.addEndpoint(node, {
                endpoint: "Dot",
                anchor: "Right",
                isSource: true,
                paintStyle: { fill: "#10b981", stroke: "#059669", strokeWidth: 2, radius: 6 },
                hoverPaintStyle: { fill: "#059669", stroke: "#047857", strokeWidth: 3, radius: 8 },
                connectorStyle: { stroke: "#64748b", strokeWidth: 2 },
                connectorHoverStyle: { stroke: "#1e40af", strokeWidth: 3 },
                connector: ["Bezier", { curviness: 80 }],
                overlays: [["Arrow", { location: 1, width: 20, length: 20 }]]
            });
            
            // 添加输入端点（左侧，红色）
            jsPlumbInstance.addEndpoint(node, {
                endpoint: "Dot",
                anchor: "Left",
                isTarget: true,
                paintStyle: { fill: "#ef4444", stroke: "#dc2626", strokeWidth: 2, radius: 6 },
                hoverPaintStyle: { fill: "#dc2626", stroke: "#b91c1c", strokeWidth: 3, radius: 8 }
            });
        }

        // 为节点设置事件监听器
        function setupNodeEvents(node) {
            if (!node) return;
            
            // 点击选中节点
            node.addEventListener('click', function(e) {
                if (isDragging || isConnecting) return;
                
                e.stopPropagation();
                
                // 清除之前选中的节点
                document.querySelectorAll('.workflow-node').forEach(n => {
                    n.classList.remove('ring-2', 'ring-blue-500');
                });
                
                // 选中当前节点
                this.classList.add('ring-2', 'ring-blue-500');
                selectedNode = this;
                
                // 显示属性面板
                showNodeProperties(this);
            });
            
            // 右键菜单
            node.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                selectedNode = this;
                showContextMenu(e.pageX, e.pageY, this);
            });
            
            // 双击编辑
            node.addEventListener('dblclick', function(e) {
                e.stopPropagation();
                showNodeProperties(this);
            });
        }

        // 画布缩放功能
        function zoomIn() {
            if (canvasState.scale < canvasState.maxScale) {
                canvasState.scale += 0.1;
                updateCanvasTransform();
                updateCoordinatesDisplay();
            }
        }

        function zoomOut() {
            if (canvasState.scale > canvasState.minScale) {
                canvasState.scale -= 0.1;
                updateCanvasTransform();
                updateCoordinatesDisplay();
            }
        }

        // 更新画布变换
        function updateCanvasTransform() {
            if (!workflowContainer) return;
            
            workflowContainer.style.transform = `translate(${canvasState.x}px, ${canvasState.y}px) scale(${canvasState.scale})`;
            updateCoordinatesDisplay();
            updateMinimapViewport();
        }

        // 更新坐标显示
        function updateCoordinatesDisplay() {
            const coordX = document.getElementById('coordX');
            const coordY = document.getElementById('coordY');
            const coordScale = document.getElementById('coordScale');
            
            if (coordX) coordX.textContent = Math.round(canvasState.x);
            if (coordY) coordY.textContent = Math.round(canvasState.y);
            if (coordScale) coordScale.textContent = Math.round(canvasState.scale * 100) + '%';
        }

        // 更新小地图视口
        function updateMinimapViewport() {
            const viewport = document.getElementById('minimapViewport');
            if (!viewport) return;
            
            // 简单的小地图视口更新
            const viewportWidth = 200 * canvasState.scale;
            const viewportHeight = 150 * canvasState.scale;
            
            viewport.style.width = Math.max(20, viewportWidth) + 'px';
            viewport.style.height = Math.max(15, viewportHeight) + 'px';
            viewport.style.left = Math.max(0, -canvasState.x / 50) + 'px';
            viewport.style.top = Math.max(0, -canvasState.y / 50) + 'px';
        }

        // 更新小地图节点
        function updateMinimapNodes() {
            // 简单实现，可以后续扩展
            console.log('小地图节点已更新');
        }

        // 更新节点计数
        function updateNodeCount() {
            const nodeCountElement = document.getElementById('nodeCount');
            if (nodeCountElement) {
                const nodeCount = document.querySelectorAll('.workflow-node').length;
                nodeCountElement.textContent = nodeCount;
            }
        }

        // 更新连接计数
        function updateConnectionCount() {
            const connectionCountElement = document.getElementById('connectionCount');
            if (connectionCountElement && jsPlumbInstance) {
                try {
                    const connectionCount = jsPlumbInstance.getConnections().length;
                    connectionCountElement.textContent = connectionCount;
                } catch (error) {
                    console.log('连接计数获取失败，使用默认值0');
                    connectionCountElement.textContent = '0';
                }
            }
        }

        // 显示右键菜单
        function showContextMenu(x, y, node) {
            const contextMenu = document.getElementById('contextMenu');
            if (contextMenu) {
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.classList.remove('hidden');
                selectedNode = node;
            }
        }

        // 隐藏右键菜单
        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            if (contextMenu) {
                contextMenu.classList.add('hidden');
            }
        }

        // 处理右键菜单操作
        function handleContextMenuAction(action, node) {
            console.log('处理右键菜单操作:', action, node);
            switch (action) {
                case 'edit':
                    showNodeProperties(node);
                    break;
                case 'copy':
                    duplicateNode(node);
                    break;
                case 'disconnect':
                    disconnectNode(node);
                    break;
                case 'delete':
                    deleteNode(node);
                    break;
                default:
                    console.log('未知的右键菜单操作:', action);
            }
        }

        // 复制节点
        function duplicateNode(node) {
            if (!node || !jsPlumbInstance) return;
            
            const rect = node.getBoundingClientRect();
            const containerRect = workflowContainer.getBoundingClientRect();
            
            // 计算在画布中的相对位置
            const x = (rect.left - containerRect.left) / canvasState.scale - canvasState.x / canvasState.scale + 50;
            const y = (rect.top - containerRect.top) / canvasState.scale - canvasState.y / canvasState.scale + 50;
            
            // 获取原节点的信息
            const nodeType = getNodeType(node);
            const nodeSubtype = getNodeSubtype(node);
            
            // 创建节点数据
            const data = {
                type: nodeType,
                subtype: nodeSubtype
            };
            
            // 创建新节点
            createNode(data, x, y);
            
            console.log('节点复制成功:', nodeType, nodeSubtype);
        }

        // 删除节点
        function deleteNode(node) {
            if (!node || !jsPlumbInstance) return;
            
            const nodeTitle = node.querySelector('.font-semibold').textContent;
            
            if (confirm(`确定要删除节点"${nodeTitle}"吗？`)) {
                // 删除所有连接
                jsPlumbInstance.deleteConnectionsForElement(node);
                
                // 删除节点
                node.remove();
                
                // 更新计数
                updateNodeCount();
                updateConnectionCount();
                
                // 清除选择
                if (selectedNode === node) {
                    selectedNode = null;
                    document.getElementById('propertiesPanel').classList.add('hidden');
                }
                
                console.log('节点删除成功:', nodeTitle);
            }
        }

        // ============= 页面切换功能 =============
        
        // 显示模板商店页面
        function showTemplatePage() {
            document.getElementById('templateStorePage').classList.remove('hidden');
            document.getElementById('workflowEditorPage').classList.add('hidden');
            document.body.className = 'bg-gray-50';
            console.log('已切换到模板商店页面');
        }

        // 显示工作流编辑器页面
        function showEditorPage() {
            document.getElementById('templateStorePage').classList.add('hidden');
            document.getElementById('workflowEditorPage').classList.remove('hidden');
            document.body.className = 'bg-gray-50 h-screen overflow-hidden';
            console.log('已切换到工作流编辑器页面');
            
            // 确保jsPlumb和画布已初始化
            setTimeout(() => {
                if (!jsPlumbInstance) {
                    console.log('重新初始化jsPlumb...');
                    initJsPlumb();
                }
                
                // 重新绑定画布事件
                if (typeof initInfiniteCanvas === 'function') {
                    console.log('重新初始化画布...');
                    initInfiniteCanvas();
                }
                
                // 如果有节点，自动适应屏幕
                const nodes = document.querySelectorAll('.workflow-node');
                if (nodes.length > 0) {
                    setTimeout(() => {
                        fitToScreen();
                        console.log('编辑器页面自动适应到现有节点');
                    }, 200);
                }
            }, 100);
        }

        // 更新导航状态
        function updateNavigation(activeBtn) {
            // 清除所有按钮的激活状态
            document.querySelectorAll('#homeBtn, #editorBtn, #monitorBtn').forEach(btn => {
                if (btn) {
                    btn.className = 'px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors';
                }
            });
            
            // 激活当前按钮
            if (activeBtn) {
                activeBtn.className = 'px-3 py-2 text-sm font-medium text-purple-600 bg-purple-50 rounded-lg';
            }
        }

        // ============= 页面初始化 =============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面开始初始化...');
            
            // 默认显示模板商店页面
            showTemplatePage();
            
            // 模板商店现在作为独立页面存在
            
            // 初始化jsPlumb
            try {
                initJsPlumb();
                console.log('jsPlumb初始化成功');
            } catch (error) {
                console.error('jsPlumb初始化失败:', error);
            }
            
            // 初始化无限画板
            try {
                initInfiniteCanvas();
                console.log('无限画板初始化成功');
            } catch (error) {
                console.error('无限画板初始化失败:', error);
            }
            
            // 如果当前在编辑器页面，则自动适应屏幕
            const editorPage = document.getElementById('editor-page');
            if (editorPage && !editorPage.classList.contains('hidden')) {
                setTimeout(() => {
                    try {
                        fitToScreen();
                        console.log('编辑器页面自动适应屏幕完成');
                    } catch (error) {
                        console.error('自动适应屏幕失败:', error);
                    }
                }, 500);
            }

            // 绑定导航按钮事件
            const homeBtn = document.getElementById('homeBtn');
            const editorBtn = document.getElementById('editorBtn');
            const backToStoreBtn = document.getElementById('backToStoreBtn');
            
            if (homeBtn) {
                homeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showTemplatePage();
                    updateNavigation(this);
                });
                console.log('工作流商店按钮事件绑定成功');
            }
            
            if (editorBtn) {
                editorBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showEditorPage();
                    updateNavigation(this);
                });
                console.log('流程编辑器按钮事件绑定成功');
            }
            
            if (backToStoreBtn) {
                backToStoreBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showTemplatePage();
                    updateNavigation(document.getElementById('homeBtn'));
                });
                console.log('返回按钮事件绑定成功');
            }
            // 绑定模板卡片点击事件
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    const templateId = this.getAttribute('data-template');
                    console.log('选择模板:', templateId);
                    
                    // 切换到编辑器页面
                    showEditorPage();
                    updateNavigation(document.getElementById('editorBtn'));
                    
                    // 延迟加载模板，确保页面切换完成
                    setTimeout(() => {
                        if (typeof loadTemplate === 'function') {
                            loadTemplate(templateId);
                        } else {
                            console.log('模板加载功能暂未实现，已切换到编辑器页面');
                        }
                    }, 300);
                });
            });
            console.log('模板卡片点击事件绑定成功');
            
            // 其他按钮事件绑定
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    console.log('保存按钮被点击');
                    if (typeof saveWorkflow === 'function') {
                        saveWorkflow();
                    } else {
                        console.log('保存功能暂未实现');
                    }
                });
            }
            
            const debugBtn = document.getElementById('debugBtn');
            if (debugBtn) {
                debugBtn.addEventListener('click', () => {
                    const debugModal = document.getElementById('debugModal');
                    if (debugModal) {
                        debugModal.classList.remove('hidden');
                    }
                });
            }
            
            const publishBtn = document.getElementById('publishBtn');
            if (publishBtn) {
                publishBtn.addEventListener('click', function() {
                    console.log('发布按钮被点击');
                    if (typeof publishWorkflow === 'function') {
                        publishWorkflow();
                    } else {
                        console.log('发布功能暂未实现');
                    }
                });
            }
            
            const closeDebug = document.getElementById('closeDebug');
            if (closeDebug) {
                closeDebug.addEventListener('click', () => {
                    const debugModal = document.getElementById('debugModal');
                    if (debugModal) {
                        debugModal.classList.add('hidden');
                    }
                });
            }
            
            const startDebug = document.getElementById('startDebug');
            if (startDebug) {
                startDebug.addEventListener('click', function() {
                    console.log('开始调试按钮被点击');
                    if (typeof startDebugMode === 'function') {
                        startDebugMode();
                    } else {
                        console.log('调试功能暂未实现');
                    }
                });
            }
            
            // 原有的模板卡片点击事件已在上面统一处理
            
            // 拖拽功能初始化
            setupDragAndDrop();

            // 侧边栏切换
            document.getElementById('toggleSidebar').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const icon = this.querySelector('i');
                
                if (sidebar.classList.contains('sidebar-expanded')) {
                    sidebar.classList.remove('sidebar-expanded');
                    sidebar.classList.add('sidebar-collapsed');
                    icon.className = 'fas fa-chevron-right';
                } else {
                    sidebar.classList.remove('sidebar-collapsed');
                    sidebar.classList.add('sidebar-expanded');
                    icon.className = 'fas fa-chevron-left';
                }
            });

            // 节点点击事件（使用事件委托和防抖）
            document.addEventListener('click', function(e) {
                // 如果正在拖拽画板，不处理点击事件
                if (canvasState && canvasState.isPanning) {
                    return;
                }
                
                // 清除之前的定时器
                if (clickTimer) {
                    clearTimeout(clickTimer);
                }
                
                // 延迟处理点击事件，避免与拖拽冲突
                clickTimer = setTimeout(() => {
                    // 如果正在拖拽或连线，忽略点击
                    if (isDragging || isConnecting || (canvasState && canvasState.isPanning)) {
                        return;
                    }
                    
                    const workflowNode = e.target.closest('.workflow-node');
                    const propertiesPanel = e.target.closest('#propertiesPanel');
                    
                    if (workflowNode) {
                        if (typeof selectNode === 'function') {
                            selectNode(workflowNode);
                        }
                    } else if (!propertiesPanel) {
                        // 只有在不是点击属性面板时才清除选择
                        if (typeof clearSelection === 'function') {
                            clearSelection();
                        }
                    }
                    
                    // 点击其他地方隐藏右键菜单（但不影响属性面板）
                    if (!e.target.closest('#contextMenu') && typeof hideContextMenu === 'function') {
                        hideContextMenu();
                    }
                }, 50);
            });

            // 画布控制按钮事件
            document.getElementById('zoomIn').addEventListener('click', zoomIn);
            document.getElementById('zoomOut').addEventListener('click', zoomOut);
            document.getElementById('zoomFit').addEventListener('click', fitToScreen);
            document.getElementById('resetView').addEventListener('click', () => {
                canvasState.x = 0;
                canvasState.y = 0;
                canvasState.scale = 1;
                updateCanvasTransform();
                setTimeout(() => {
                    fitToScreen();
                }, 100);
            });

            // 右键菜单事件
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#contextMenu')) {
                    hideContextMenu();
                }
            });

            document.getElementById('contextMenu').addEventListener('click', function(e) {
                const action = e.target.dataset.action || e.target.parentElement.dataset.action;
                if (action && selectedNode) {
                    handleContextMenuAction(action, selectedNode);
                }
                hideContextMenu();
            });

            // 属性面板关闭按钮事件
            const closePropertiesPanel = document.getElementById('closePropertiesPanel');
            if (closePropertiesPanel) {
                closePropertiesPanel.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (typeof clearSelection === 'function') {
                        clearSelection();
                    }
                });
            }

            // 初始化节点计数
            try {
                updateNodeCount();
                updateConnectionCount();
                console.log('节点和连接计数更新完成');
            } catch (error) {
                console.error('节点计数更新失败:', error);
            }

            // 最终状态检查
            setTimeout(() => {
                console.log('🎉 页面初始化完成，默认显示模板商店页面');
            }, 100);
        });
    </script>
</body>
</html> 
